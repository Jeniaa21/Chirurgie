import React, { useMemo, useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { Separator } from "@/components/ui/separator";
import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem, DropdownMenuCheckboxItem, DropdownMenuLabel } from "@/components/ui/dropdown-menu";
import { Copy, Download, Search, ListChecks, ClipboardList, Stethoscope, Activity, FileText, Filter, RotateCcw } from "lucide-react";

// ------------------------------
// Données cliniques (synthèse RP)
// ------------------------------

// ⚠️ NOTE IMPORTANTE (RP):
// Ce contenu est pensé pour le jeu de rôle (GTA RP) uniquement. 
// Il NE REMPLACE PAS un avis médical réel. Aucune posologie n'est fournie.

const CATEGORIES = [
  "Orthopédie/Os",
  "Crâne/Neurochir",
  "Rachis",
  "Muscles/Tendons",
  "Thorax",
  "Cardiaque",
  "Viscéral/Abdomen",
  "Grands brûlés",
  "Neurologie traumatique",
];

const bank = [
  {
    id: "os-fix",
    titre: "Réparation osseuse (broches/vis/plaques/pâte)",
    categorie: "Orthopédie/Os",
    tags: ["fracture", "broches", "vis", "plaques", "pâte osseuse"],
    examens: [
      "Inspection + douleur provoquée, déformation, plaie ouverte",
      "Contrôle vasculo-nerveux distal (pouls, sensibilité, motricité)",
      "Immobilisation provisoire (attelle) avant transport",
      "Imagerie RP: radio/scan si dispo en service",
    ],
    gestes: [
      "Hémostase locale si plaie",
      "Attelle modelable, glace externe",
      "Antalgie non chiffrée (RP)",
      "Transport vers bloc si fracture instable/ouverte",
    ],
    bloc: [
      "Broches/clous IM: réalignement + verrouillage",
      "Plaques + vis anatomiques si fracture articulaire/complexe",
      "Pâte/greffe osseuse si perte de substance",
    ],
    postop: [
      "Contrôle vasculo-nerveux post-immobilisation",
      "Imagerie de contrôle",
      "Décharge/béquilles selon segment",
    ],
    rapportPoints: ["Os concerné", "Type de fracture", "Gestes d'urgence", "Fixation réalisée", "Surveillance"],
  },
  {
    id: "crane",
    titre: "Chirurgie crânienne (craniotomie / crânioplastie)",
    categorie: "Crâne/Neurochir",
    tags: ["TCC", "hématome", "craniotomie", "crânioplastie", "plaques crâniennes"],
    examens: [
      "Score de Glasgow, pupilles, déficit focal",
      "Stabilisation cervicale jusqu'à imagerie",
      "Scan crâne si dispo (RP)",
    ],
    gestes: [
      "ABCDE avec surveillance G",
      "Oxygénation, contrôle des convulsions si besoin (RP)",
      "Préparation bloc si hématome compressif",
    ],
    bloc: [
      "Craniotomie: volet + évacuation hématome",
      "Plaques/vis titane pour refixation",
      "Crânioplastie ou ciment (PMMA/hydroxyapatite) si défaut",
    ],
    postop: [
      "Surveillance neuro rapprochée",
      "Scan de contrôle",
      "Prévention infection",
    ],
    rapportPoints: ["Mécanisme", "Glasgow", "Lésions scan", "Geste neurochir", "Évolution immédiate"],
  },
  {
    id: "rachis",
    titre: "Rachis (discectomie, laminectomie, fusion, foraminotomie)",
    categorie: "Rachis",
    tags: ["rachis", "hernie discale", "sténose", "fracture", "scoliose"],
    examens: [
      "Immobilisation stricte du rachis",
      "Évaluation sensitivo-motrice et périnée",
      "Scan/IRM selon RP",
    ],
    gestes: [
      "Collier + plan dur",
      "Antalgie prudente (RP)",
      "Transport bloc si déficit évolutif/instabilité",
    ],
    bloc: [
      "Discectomie si conflit disque-nerf",
      "Laminectomie pour décompression",
      "Fusion + vis/tiges, cage si instabilité",
    ],
    postop: ["Surveillance neuro", "Mobilisation encadrée", "Imagerie de contrôle"],
    rapportPoints: ["Niveau lésionnel", "Déficit", "Imagerie", "Geste réalisé", "Stabilité finale"],
  },
  {
    id: "muscle",
    titre: "Rupture musculaire (partielle/complète)",
    categorie: "Muscles/Tendons",
    tags: ["déchirure", "rupture", "suture musculaire", "rééducation"],
    examens: [
      "Douleur localisée, hématome, déficit fonctionnel",
      "Échelle douleur RP",
      "Échographie si dispo",
    ],
    gestes: ["Repos, glace, compression, élévation (RICE)", "Immobilisation courte", "Antalgie RP"],
    bloc: ["Suture des berges musculaires", "Renfort tendineux si besoin"],
    postop: ["Immobilisation initiale", "Mobilisation douce", "Renforcement progressif"],
    rapportPoints: ["Muscle atteint", "Type (partielle/complète)", "Gestes d'urgence", "Réparation", "Programme réhab"],
  },
  {
    id: "thorax",
    titre: "Chirurgie thoracique (lobe, médiastin, trachée, trauma)",
    categorie: "Thorax",
    tags: ["lobectomie", "pneumothorax", "hémothorax", "décortication", "trachéotomie"],
    examens: ["Détresse respi?", "Auscultation, saturation", "Écho FAST/Radio si dispo"],
    gestes: [
      "Aiguille décompression si pneumo sous tension (RP)",
      "Drain thoracique si indiqué (RP)",
      "Oxygène et analgésie RP",
    ],
    bloc: [
      "Lobectomie/segmentectomie selon lésion",
      "Décortication pleurale",
      "Trachéotomie si voie aérienne compromise",
    ],
    postop: ["Surveillance respi + drains", "Kiné respi", "Contrôle fuites d'air"],
    rapportPoints: ["Mécanisme/Pathologie", "Côté atteint", "Gestes préhospitaliers", "Geste thoracique", "Drains"]
  },
  {
    id: "cardiaque",
    titre: "Cardiaque (pontage, valves, FA, DAV)",
    categorie: "Cardiaque",
    tags: ["pontage", "valve", "FA", "transplantation", "DAV"],
    examens: ["Douleur thoracique?", "ECG si RP", "Écho si dispo"],
    gestes: ["ABCDE + O2 si SpO2 basse", "Anti-douleur RP", "Prépa bloc si instabilité"],
    bloc: ["Pontage coronarien", "Réparation/remplacement valvulaire", "Ablation/MAZE", "Implant DAV"],
    postop: ["Surveillance en USIC/REA", "Prévention infection", "Rééducation cardiaque"],
    rapportPoints: ["Diagnostic", "Geste cardiaque", "CPEC (REA/USIC)", "Évolution"],
  },
  {
    id: "visc",
    titre: "Viscéral/Abdomen (appendice, vésicule, hernie, résection…)",
    categorie: "Viscéral/Abdomen",
    tags: ["appendicite", "vésicule", "hernie", "résection", "gastrectomie", "bariatrique", "foie", "pancréas", "rate"],
    examens: ["Douleur, défense/contracture", "N/V, transit", "FAST/Scan RP"],
    gestes: ["Jeûne + VVP (RP)", "Antalgie RP", "Préparation bloc si abdomen aigu/trauma"],
    bloc: [
      "Appendicectomie (souvent coelio)",
      "Cholécystectomie coelio",
      "Herniorraphie/mesh",
      "Résection intestinale ± stomie",
      "Gastrectomie / sleeve",
      "Hépatectomie partielle",
      "Pancréatectomie (Whipple/distale)",
      "Splénectomie",
    ],
    postop: ["Surveillance souillures/saignement", "Reprise du transit", "Douleur"],
    rapportPoints: ["Organe", "Diagnostic", "Voie d'abord", "Geste", "Suites"],
  },
  {
    id: "brules",
    titre: "Grands brûlés",
    categorie: "Grands brûlés",
    tags: ["SCB", "Parkland", "greffe peau", "débridement"],
    examens: [
      "Évaluer profondeur + %SCB (règle des 9 / Lund-Browder RP)",
      "Voies aériennes (inhalation?)",
    ],
    gestes: [
      "Refroidir (pas de glace directe prolongée)",
      "Retirer vêtements/objets chauds",
      "Voie veineuse, réanimation liquidienne (RP, formule de Parkland en info seulement)",
      "Antalgie RP",
    ],
    bloc: ["Débridement", "Greffes cutanées", "Pansements spécifiques"],
    postop: ["Kiné + orthèses", "Suivi psycho", "Gestion cicatrices"],
    rapportPoints: ["Mécanisme", "%SCB estimée", "Zones atteintes", "Gestes/initiaux", "Greffes"],
  },
  {
    id: "neurotrauma",
    titre: "Neurologie traumatique (TCC, moelle, nerfs périph.)",
    categorie: "Neurologie traumatique",
    tags: ["TCC", "lésion médullaire", "périphérique", "décompression"],
    examens: ["ABCDE + Glasgow", "Immobilisation rachis", "Scan/IRM RP"],
    gestes: ["Stabiliser VA/O2", "Prévenir hypotension/hypoxie", "Transport rapide vers spécialité"],
    bloc: ["Craniotomie décompressive", "Fixation rachidienne", "Réparation nerveuse"],
    postop: ["Rééducation pluridisciplinaire", "Prévention escarres/TVP", "Suivi long cours"],
    rapportPoints: ["Type lésion", "Score GCS", "Gestes d'urgence", "Chirurgie", "Plan réhab"],
  },
];

const checklists = {
  ABCDE: [
    "A — Airway: perméabilité, colliers si trauma",
    "B — Breathing: FR, SpO2, auscultation, désamorcer pneumo si tension (RP)",
    "C — Circulation: pouls, hémorragies, perfusion",
    "D — Disability: Glasgow, pupilles, déficit",
    "E — Exposure: déshabiller, température, recherche lésions",
  ],
  TraumaThorax: [
    "Inspection cage (emphysème sous-cutané, volet costal)",
    "Percussion (hypersonorité/tympanisme)",
    "Auscultation (asymétrie)",
    "Si détresse + déviation trachéale ⇒ décompression (RP)",
  ],
  Brules: [
    "Arrêt agent vulnérant, refroidissement 10-20 min",
    "Évaluer %SCB (RP)",
    "Voies aériennes: fumées, raucité, suie",
    "Couvrir stérile/film alimentaire (RP)",
  ],
};

// ------------------------------
// Utilitaires
// ------------------------------

function cx(...cls){ return cls.filter(Boolean).join(" "); }

function downloadText(filename, text){
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ------------------------------
// Composant principal
// ------------------------------

export default function App(){
  const [q, setQ] = useState("");
  const [catFilter, setCatFilter] = useState(CATEGORIES);
  const [selected, setSelected] = useState(null);
  const [report, setReport] = useState("");
  const [includeChecklist, setIncludeChecklist] = useState({ ABCDE: true, TraumaThorax: false, Brules: false });

  useEffect(()=>{
    const cached = localStorage.getItem("gta_rp_chir_report");
    if(cached) setReport(cached);
  },[]);
  useEffect(()=>{
    localStorage.setItem("gta_rp_chir_report", report);
  },[report]);

  const filtered = useMemo(()=>{
    const lower = q.toLowerCase();
    return bank.filter(it =>
      catFilter.includes(it.categorie) && (
        !lower || it.titre.toLowerCase().includes(lower) || it.tags.join(" ").toLowerCase().includes(lower)
      )
    );
  }, [q, catFilter]);

  function makeReport(item){
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    const dateStr = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    const checklistText = Object.entries(includeChecklist)
      .filter(([k,v])=>v)
      .map(([k])=>`\nChecklist ${k}:\n- ` + checklists[k].join("\n- "))
      .join("\n");

    return `RAPPORT MÉDICAL — Chirurgie complexe (RP)\nDate/Heure: ${dateStr}\n\nPatient: __________________  Âge: __  Sexe: __  ID RP: ________\nMéca/Contexte: _________________________________________________\n\nCATÉGORIE: ${item.categorie}\nCAS: ${item.titre}\n\nEXAMENS:\n- ${item.examens.join("\n- ")}\n\nGESTES INITIAUX:\n- ${item.gestes.join("\n- ")}\n\nBLOC/OPÉRATION:\n- ${item.bloc.join("\n- ")}\n\nPOST-OP / SURVEILLANCE:\n- ${item.postop.join("\n- ")}\n${checklistText}\n\nPOINTS CLÉS À DOCUMENTER:\n- ${item.rapportPoints.join("\n- ")}\n\nRemarques complémentaires: _____________________________________\nSignature: __________`;
  }

  function handleCompose(item){
    const base = makeReport(item);
    setReport(base);
    setSelected(item.id);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function resetFilters(){ setQ(""); setCatFilter(CATEGORIES); }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
      <header className="sticky top-0 z-30 backdrop-blur bg-white/70 border-b">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <Stethoscope className="w-6 h-6" />
          <h1 className="text-xl font-semibold">Chirurgie Complexe — Guide RP</h1>
          <Badge variant="secondary" className="ml-auto">Hôpital — GTA RP</Badge>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
        {/* Colonne gauche: Recherche + Filtres + Résultats */}
        <section className="lg:col-span-2 space-y-4">
          <Card className="shadow-sm">
            <CardHeader className="pb-2">
              <CardTitle className="text-base">Chercher une blessure / un acte</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="flex gap-2 items-center">
                <div className="relative flex-1">
                  <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 opacity-60" />
                  <Input value={q} onChange={e=>setQ(e.target.value)} placeholder="fracture, rachis, brûlure, valve…" className="pl-9" />
                </div>
                <Button variant="outline" onClick={resetFilters}><RotateCcw className="w-4 h-4 mr-2"/>Réinitialiser</Button>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="secondary"><Filter className="w-4 h-4 mr-2"/>Catégories</Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent className="w-64">
                    <DropdownMenuLabel>Afficher</DropdownMenuLabel>
                    {CATEGORIES.map(cat => (
                      <DropdownMenuCheckboxItem
                        key={cat}
                        checked={catFilter.includes(cat)}
                        onCheckedChange={(v)=>{
                          setCatFilter(prev => v ? [...prev, cat] : prev.filter(c=>c!==cat));
                        }}
                      >{cat}</DropdownMenuCheckboxItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>
              </div>

              <div className="grid md:grid-cols-2 gap-3">
                {filtered.map(item => (
                  <Card key={item.id} className={cx("border", selected===item.id && "ring-2 ring-slate-900/10")}> 
                    <CardHeader className="pb-2">
                      <CardTitle className="text-sm font-semibold leading-tight">{item.titre}</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                      <div className="flex flex-wrap gap-1">
                        <Badge variant="outline">{item.categorie}</Badge>
                        {item.tags.slice(0,3).map(t => <Badge key={t} variant="secondary">{t}</Badge>)}
                      </div>
                      <div className="flex gap-2 pt-1">
                        <Button size="sm" onClick={()=>handleCompose(item)}><ClipboardList className="w-4 h-4 mr-1"/>Composer rapport</Button>
                        <Button size="sm" variant="outline" onClick={()=>setSelected(item.id)}><ListChecks className="w-4 h-4 mr-1"/>Voir détails</Button>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>

              {selected && (
                <Details item={bank.find(b=>b.id===selected)!} includeChecklist={includeChecklist} setIncludeChecklist={setIncludeChecklist} onCompose={handleCompose} />
              )}
            </CardContent>
          </Card>
        </section>

        {/* Colonne droite: Rapport */}
        <section className="space-y-4">
          <Card className="shadow-sm sticky top-20">
            <CardHeader className="pb-2">
              <div className="flex items-center gap-2">
                <FileText className="w-5 h-5"/>
                <CardTitle className="text-base">Rapport médical (générateur)</CardTitle>
              </div>
            </CardHeader>
            <CardContent className="space-y-3">
              <Textarea
                className="min-h-[380px] font-mono"
                value={report}
                onChange={(e)=>setReport(e.target.value)}
                placeholder={"Cliquez sur \"Composer rapport\" depuis une fiche pour pré-remplir ici…"}
              />
              <div className="flex gap-2 justify-end">
                <Button variant="outline" onClick={()=>{ navigator.clipboard.writeText(report||""); }}><Copy className="w-4 h-4 mr-2"/>Copier</Button>
                <Button onClick={()=>downloadText("rapport_chirurgie_RP.txt", report||"")}><Download className="w-4 h-4 mr-2"/>Télécharger</Button>
              </div>
              <Separator/>
              <div className="space-y-2">
                <p className="text-sm font-medium">Inclure des checklists</p>
                {Object.keys(checklists).map((key)=> (
                  <label key={key} className="flex items-center gap-2 text-sm">
                    <Checkbox checked={includeChecklist[key]} onCheckedChange={(v)=>setIncludeChecklist(prev=>({...prev, [key]: !!v}))}/>
                    <span>{key}</span>
                  </label>
                ))}
              </div>
            </CardContent>
          </Card>
        </section>
      </main>

      <footer className="max-w-7xl mx-auto px-4 pb-8 text-xs text-slate-500">
        <Separator className="mb-3"/>
        <p>
          ⚠️ Outil de jeu — GTA RP. Pour simplifier les scènes et rapports. 
          Procédures simplifiées et non prescriptives. Aucune information ici n'est un conseil médical réel.
        </p>
      </footer>
    </div>
  );
}

function Details({ item, includeChecklist, setIncludeChecklist, onCompose }){
  return (
    <Card className="shadow-sm">
      <CardHeader className="pb-2">
        <CardTitle className="text-base">Détails — {item.titre}</CardTitle>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="examens" className="w-full">
          <TabsList className="grid grid-cols-5">
            <TabsTrigger value="examens">Examens</TabsTrigger>
            <TabsTrigger value="gestes">Gestes</TabsTrigger>
            <TabsTrigger value="bloc">Bloc</TabsTrigger>
            <TabsTrigger value="postop">Post-op</TabsTrigger>
            <TabsTrigger value="rapport">Rapport</TabsTrigger>
          </TabsList>
          <TabsContent value="examens">
            <Bullets items={item.examens}/>
          </TabsContent>
          <TabsContent value="gestes">
            <Bullets items={item.gestes}/>
          </TabsContent>
          <TabsContent value="bloc">
            <Bullets items={item.bloc}/>
          </TabsContent>
          <TabsContent value="postop">
            <Bullets items={item.postop}/>
          </TabsContent>
          <TabsContent value="rapport">
            <div className="space-y-3">
              <p className="text-sm">Points clés à documenter :</p>
              <div className="flex flex-wrap gap-1">
                {item.rapportPoints.map((p)=> (<Badge key={p} variant="secondary">{p}</Badge>))}
              </div>
              <div className="flex gap-2">
                <Button onClick={()=>onCompose(item)}><ClipboardList className="w-4 h-4 mr-2"/>Composer un rapport</Button>
              </div>
              <Separator/>
              <p className="text-xs text-slate-500">Ajouts automatiques possibles :</p>
              <div className="grid sm:grid-cols-3 gap-2">
                {Object.keys(checklists).map(key => (
                  <label key={key} className="flex items-center gap-2 text-sm">
                    <Checkbox checked={includeChecklist[key]} onCheckedChange={(v)=>setIncludeChecklist(prev=>({...prev, [key]: !!v}))}/>
                    <span>Inclure checklist {key}</span>
                  </label>
                ))}
              </div>
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
}

function Bullets({ items }){
  return (
    <ul className="list-disc pl-5 space-y-1 text-sm">
      {items.map((x, i)=> <li key={i}>{x}</li>)}
    </ul>
  );
}
