<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chirurgie Complexe â€” GTA RP</title>
  <!-- Tailwind CDN (runtime) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind in CDN: enable class-based dark mode
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    /* --- Design tokens (light/dark) --- */
    :root{
      --bg: #f8fafc;             /* slate-50 */
      --panel: #ffffff;           /* white */
      --border: #e2e8f0;          /* slate-200 */
      --text: #0f172a;            /* slate-900 */
      --muted: #64748b;           /* slate-500 */
      --chip: #f1f5f9;            /* slate-100 */
      --shadow: 0 8px 24px rgba(2,6,23,.06);
      --ring: rgba(15,23,42,.12);
      --accent: #0f172a;          /* slate-900 */
    }
    .dark{
      --bg: #0b1220;             /* custom dark */
      --panel: #0f172a;           /* slate-900 */
      --border: #1f2937;          /* gray-800 */
      --text: #e5e7eb;            /* gray-200 */
      --muted: #94a3b8;          /* slate-400 */
      --chip: #111827;            /* gray-900 */
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --ring: rgba(148,163,184,.2);
      --accent: #38bdf8;          /* sky-400 */
    }
    /* --- Utility classes (no @apply to keep CDN happy) --- */
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:1rem; box-shadow:var(--shadow); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.75rem; border:1px solid var(--border); font-weight:600; font-size:.9rem; }
    .btn:hover{ box-shadow:0 0 0 6px var(--ring); }
    .btn-primary{ background:var(--accent); color:white; border-color:var(--accent); }
    .btn-ghost{ background:var(--panel); color:var(--text); }
    .badge{ display:inline-flex; align-items:center; padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; border:1px solid var(--border); background:var(--chip); color:var(--muted); }
    .tabs button{ padding:.4rem .75rem; border-radius:.6rem; font-weight:600; font-size:.9rem; color:var(--muted); }
    .tabs button.active{ background:var(--accent); color:white; }
    .list-dash li{ position: relative; padding-left: 1rem; }
    .list-dash li::before{ content: "â€¢"; position: absolute; left: 0; color:var(--accent); }
    .sticky-col{ position: sticky; top: 6rem; }
    .field{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:.75rem; padding:.6rem .75rem; }
    details.dropdown > summary{ list-style:none; }
    details.dropdown[open] > summary{ box-shadow:0 0 0 6px var(--ring); }
    .menu{ border:1px solid var(--border); background:var(--panel); border-radius:.75rem; box-shadow:var(--shadow); }
    .menu label{ display:flex; align-items:center; gap:.5rem; padding:.4rem .5rem; border-radius:.5rem; cursor:pointer; }
    .menu label:hover{ background:rgba(148,163,184,.08); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border:1px solid var(--border); background:var(--chip); padding:.1rem .35rem; border-radius:.4rem; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-30 backdrop-blur border-b" style="background:color-mix(in oklab,var(--panel) 80%, transparent)">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ©º</span>
        <h1 class="text-lg md:text-xl font-semibold">Chirurgie Complexe â€” Guide RP</h1>
      </div>
      <span class="ml-auto badge">HÃ´pital â€” GTA RP</span>
      <button id="themeToggle" class="btn btn-ghost ml-2" title="Mode sombre (t)">ğŸŒ— <span class="hidden md:inline">ThÃ¨me</span></button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Colonne gauche: recherche + rÃ©sultats -->
    <section class="lg:col-span-2 space-y-4">
      <div class="card p-4">
        <div class="flex flex-col gap-4">
          <div class="flex flex-wrap gap-2 items-center">
            <div class="relative grow">
              <input id="q" class="field pl-10 w-full" placeholder="Rechercher: fracture, rachis, brÃ»lure, valveâ€¦" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-60">ğŸ”</span>
            </div>
            <button id="btnReset" class="btn btn-ghost">â†º RÃ©initialiser</button>
            <details class="relative dropdown">
              <summary class="btn btn-ghost cursor-pointer select-none">ğŸ—‚ï¸ CatÃ©gories</summary>
              <div class="absolute right-0 mt-2 w-72 p-2 menu z-10">
                <div class="text-sm font-semibold mb-1">Afficher</div>
                <div id="catList" class="grid grid-cols-1 gap-1"></div>
                <div class="flex justify-end pt-2"><button id="btnAllCats" class="btn btn-ghost">Tout cocher</button></div>
              </div>
            </details>
          </div>

          <div id="results" class="grid md:grid-cols-2 gap-3"></div>

          <div id="detailsWrap"></div>
        </div>
      </div>
    </section>

    <!-- Colonne droite: rapport -->
    <aside class="space-y-4">
      <div class="card p-4 sticky-col">
        <div class="flex items-center gap-2 mb-2">
          <span>ğŸ“</span>
          <h2 class="text-base font-semibold">Rapport mÃ©dical (gÃ©nÃ©rateur)</h2>
        </div>
        <textarea id="report" class="w-full min-h-[380px] field font-mono" placeholder="Clique sur &quot;Composer rapport&quot; depuis une fiche pour prÃ©-remplir iciâ€¦"></textarea>
        <div class="flex gap-2 justify-end mt-2">
          <button id="btnCopy" class="btn btn-ghost">ğŸ“‹ Copier</button>
          <button id="btnDownload" class="btn btn-primary">â¬‡ï¸ TÃ©lÃ©charger</button>
        </div>
        <hr class="my-3" style="border-color:var(--border)" />
        <p class="text-sm" style="color:var(--muted)">
          Le rapport gÃ©nÃ©rÃ© contient uniquement : <b>BLOC/OPÃ‰RATION</b> et <b>POST-OP / SURVEILLANCE</b>.
        </p>
      </div>
    </aside> bg-[var(--chip)] w-3/4"></div>
      <div class="flex gap-1 mt-2">
        <div class="h-5 w-16 rounded bg-[var(--chip)]"></div>
        <div class="h-5 w-14 rounded bg-[var(--chip)]"></div>
        <div class="h-5 w-12 rounded bg-[var(--chip)]"></div>
      </div>
      <div class="flex gap-2 pt-3">
        <div class="h-9 w-36 rounded bg-[var(--chip)]"></div>
        <div class="h-9 w-32 rounded bg-[var(--chip)]"></div>
      </div>
    </div>
  </template>

  <script>
  // ------------------------------
  // ThÃ¨me (dark/light) avec persistance
  // ------------------------------
  const root = document.documentElement;
  const THEME_KEY = 'gta_rp_theme';
  function setTheme(mode){
    if(mode==='dark'){ root.classList.add('dark'); localStorage.setItem(THEME_KEY,'dark'); }
    else { root.classList.remove('dark'); localStorage.setItem(THEME_KEY,'light'); }
  }
  (function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved){ setTheme(saved); } else if(window.matchMedia('(prefers-color-scheme: dark)').matches){ setTheme('dark'); }
  })();
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    const isDark = root.classList.contains('dark'); setTheme(isDark?'light':'dark');
  });
  window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='t'){ document.getElementById('themeToggle').click(); }});

  // ------------------------------
  // DonnÃ©es (synthÃ¨se RP)
  // ------------------------------
  const CATEGORIES = [
    "OrthopÃ©die/Os",
    "CrÃ¢ne/Neurochir",
    "Rachis",
    "Muscles/Tendons",
    "Thorax",
    "Cardiaque",
    "ViscÃ©ral/Abdomen",
    "Grands brÃ»lÃ©s",
    "Neurologie traumatique",
  ];

  const bank = [
    { id: 'os-fix', titre: 'RÃ©paration osseuse (broches/vis/plaques/pÃ¢te)', categorie: 'OrthopÃ©die/Os', tags: ['fracture','broches','vis','plaques','pÃ¢te osseuse'],
      examens:["Inspection + douleur provoquÃ©e, dÃ©formation, plaie ouverte","ContrÃ´le vasculo-nerveux distal (pouls, sensibilitÃ©, motricitÃ©)","Immobilisation provisoire (attelle) avant transport","Imagerie RP: radio/scan si dispo en service"],
      gestes:["HÃ©mostase locale si plaie","Attelle modelable, glace externe","Antalgie non chiffrÃ©e (RP)","Transport vers bloc si fracture instable/ouverte"],
      bloc:["Broches/clous IM: rÃ©alignement + verrouillage","Plaques + vis anatomiques si fracture articulaire/complexe","PÃ¢te/greffe osseuse si perte de substance"],
      postop:["ContrÃ´le vasculo-nerveux post-immobilisation","Imagerie de contrÃ´le","DÃ©charge/bÃ©quilles selon segment"],
      rapportPoints:["Os concernÃ©","Type de fracture","Gestes d'urgence","Fixation rÃ©alisÃ©e","Surveillance"] },
    { id: 'crane', titre: 'Chirurgie crÃ¢nienne (craniotomie / crÃ¢nioplastie)', categorie: 'CrÃ¢ne/Neurochir', tags: ['TCC','hÃ©matome','craniotomie','crÃ¢nioplastie','plaques crÃ¢niennes'],
      examens:["Score de Glasgow, pupilles, dÃ©ficit focal","Stabilisation cervicale jusqu'Ã  imagerie","Scan crÃ¢ne si dispo (RP)"],
      gestes:["ABCDE avec surveillance G","OxygÃ©nation, contrÃ´le des convulsions si besoin (RP)","PrÃ©paration bloc si hÃ©matome compressif"],
      bloc:["Craniotomie: volet + Ã©vacuation hÃ©matome","Plaques/vis titane pour refixation","CrÃ¢nioplastie ou ciment (PMMA/hydroxyapatite) si dÃ©faut"],
      postop:["Surveillance neuro rapprochÃ©e","Scan de contrÃ´le","PrÃ©vention infection"],
      rapportPoints:["MÃ©canisme","Glasgow","LÃ©sions scan","Geste neurochir","Ã‰volution immÃ©diate"] },
    { id: 'rachis', titre: 'Rachis (discectomie, laminectomie, fusion, foraminotomie)', categorie: 'Rachis', tags:['rachis','hernie discale','stÃ©nose','fracture','scoliose'],
      examens:["Immobilisation stricte du rachis","Ã‰valuation sensitivo-motrice et pÃ©rinÃ©e","Scan/IRM selon RP"],
      gestes:["Collier + plan dur","Antalgie prudente (RP)","Transport bloc si dÃ©ficit Ã©volutif/instabilitÃ©"],
      bloc:["Discectomie si conflit disque-nerf","Laminectomie pour dÃ©compression","Fusion + vis/tiges, cage si instabilitÃ©"],
      postop:["Surveillance neuro","Mobilisation encadrÃ©e","Imagerie de contrÃ´le"],
      rapportPoints:["Niveau lÃ©sionnel","DÃ©ficit","Imagerie","Geste rÃ©alisÃ©","StabilitÃ© finale"] },
    { id: 'muscle', titre: 'Rupture musculaire (partielle/complÃ¨te)', categorie: 'Muscles/Tendons', tags:['dÃ©chirure','rupture','suture musculaire','rÃ©Ã©ducation'],
      examens:["Douleur localisÃ©e, hÃ©matome, dÃ©ficit fonctionnel","Ã‰chelle douleur RP","Ã‰chographie si dispo"],
      gestes:["Repos, glace, compression, Ã©lÃ©vation (RICE)","Immobilisation courte","Antalgie RP"],
      bloc:["Suture des berges musculaires","Renfort tendineux si besoin"],
      postop:["Immobilisation initiale","Mobilisation douce","Renforcement progressif"],
      rapportPoints:["Muscle atteint","Type (partielle/complÃ¨te)","Gestes d'urgence","RÃ©paration","Programme rÃ©hab"] },
    { id: 'thorax', titre: 'Chirurgie thoracique (lobe, mÃ©diastin, trachÃ©e, trauma)', categorie: 'Thorax', tags:['lobectomie','pneumothorax','hÃ©mothorax','dÃ©cortication','trachÃ©otomie'],
      examens:["DÃ©tresse respi?","Auscultation, saturation","Ã‰cho FAST/Radio si dispo"],
      gestes:["Aiguille dÃ©compression si pneumo sous tension (RP)","Drain thoracique si indiquÃ© (RP)","OxygÃ¨ne et analgÃ©sie RP"],
      bloc:["Lobectomie/segmentectomie selon lÃ©sion","DÃ©cortication pleurale","TrachÃ©otomie si voie aÃ©rienne compromise"],
      postop:["Surveillance respi + drains","KinÃ© respi","ContrÃ´le fuites d'air"],
      rapportPoints:["MÃ©canisme/Pathologie","CÃ´tÃ© atteint","Gestes prÃ©hospitaliers","Geste thoracique","Drains"] },
    { id: 'cardiaque', titre: 'Cardiaque (pontage, valves, FA, DAV)', categorie: 'Cardiaque', tags:['pontage','valve','FA','transplantation','DAV'],
      examens:["Douleur thoracique?","ECG si RP","Ã‰cho si dispo"],
      gestes:["ABCDE + O2 si SpO2 basse","Anti-douleur RP","PrÃ©pa bloc si instabilitÃ©"],
      bloc:["Pontage coronarien","RÃ©paration/remplacement valvulaire","Ablation/MAZE","Implant DAV"],
      postop:["Surveillance en USIC/REA","PrÃ©vention infection","RÃ©Ã©ducation cardiaque"],
      rapportPoints:["Diagnostic","Geste cardiaque","CPEC (REA/USIC)","Ã‰volution"] },
    { id: 'visc', titre: 'ViscÃ©ral/Abdomen (appendice, vÃ©sicule, hernie, rÃ©sectionâ€¦)', categorie: 'ViscÃ©ral/Abdomen', tags:['appendicite','vÃ©sicule','hernie','rÃ©section','gastrectomie','bariatrique','foie','pancrÃ©as','rate'],
      examens:["Douleur, dÃ©fense/contracture","N/V, transit","FAST/Scan RP"],
      gestes:["JeÃ»ne + VVP (RP)","Antalgie RP","PrÃ©paration bloc si abdomen aigu/trauma"],
      bloc:["Appendicectomie (souvent coelio)","CholÃ©cystectomie coelio","Herniorraphie/mesh","RÃ©section intestinale Â± stomie","Gastrectomie / sleeve","HÃ©patectomie partielle","PancrÃ©atectomie (Whipple/distale)","SplÃ©nectomie"],
      postop:["Surveillance souillures/saignement","Reprise du transit","Douleur"],
      rapportPoints:["Organe","Diagnostic","Voie d'abord","Geste","Suites"] },
    { id: 'brules', titre: 'Grands brÃ»lÃ©s', categorie: 'Grands brÃ»lÃ©s', tags:['SCB','Parkland','greffe peau','dÃ©bridement'],
      examens:["Ã‰valuer profondeur + %SCB (rÃ¨gle des 9 / Lund-Browder RP)","Voies aÃ©riennes (inhalation?)"],
      gestes:["Refroidir (pas de glace directe prolongÃ©e)","Retirer vÃªtements/objets chauds","Voie veineuse, rÃ©animation liquidienne (RP, formule de Parkland en info seulement)","Antalgie RP"],
      bloc:["DÃ©bridement","Greffes cutanÃ©es","Pansements spÃ©cifiques"],
      postop:["KinÃ© + orthÃ¨ses","Suivi psycho","Gestion cicatrices"],
      rapportPoints:["MÃ©canisme","%SCB estimÃ©e","Zones atteintes","Gestes/initiaux","Greffes"] },
    { id: 'neurotrauma', titre: 'Neurologie traumatique (TCC, moelle, nerfs pÃ©riph.)', categorie: 'Neurologie traumatique', tags:['TCC','lÃ©sion mÃ©dullaire','pÃ©riphÃ©rique','dÃ©compression'],
      examens:["ABCDE + Glasgow","Immobilisation rachis","Scan/IRM RP"],
      gestes:["Stabiliser VA/O2","PrÃ©venir hypotension/hypoxie","Transport rapide vers spÃ©cialitÃ©"],
      bloc:["Craniotomie dÃ©compressive","Fixation rachidienne","RÃ©paration nerveuse"],
      postop:["RÃ©Ã©ducation pluridisciplinaire","PrÃ©vention escarres/TVP","Suivi long cours"],
      rapportPoints:["Type lÃ©sion","Score GCS","Gestes d'urgence","Chirurgie","Plan rÃ©hab"] },
  ];

  const checklists = {
    ABCDE: ["A â€” Airway: permÃ©abilitÃ©, collier si trauma","B â€” Breathing: FR, SpO2, auscultation, dÃ©compression si tension (RP)","C â€” Circulation: pouls, hÃ©morragies, perfusion","D â€” Disability: Glasgow, pupilles, dÃ©ficit","E â€” Exposure: dÃ©shabiller, tempÃ©rature, lÃ©sions"],
    TraumaThorax: ["Inspection cage (emphysÃ¨me SC, volet costal)","Percussion (hyper/tympanisme)","Auscultation (asymÃ©trie)","Si dÃ©tresse + dÃ©viation trachÃ©ale â‡’ dÃ©compression (RP)"],
    Brules: ["ArrÃªt agent vulnÃ©rant, refroidissement 10-20 min","Ã‰valuer %SCB (RP)","Voies aÃ©riennes: suspicion inhalation","Couvrir stÃ©rile/film alimentaire (RP)"]
  };

  // ------------------------------
  // Helpers
  // ------------------------------
  const $ = (sel) => document.querySelector(sel);
  function blobDownload(filename, text){ const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }
  function formatDate(){ const n = new Date(); const pad = (x)=> String(x).padStart(2,'0'); return `${pad(n.getDate())}/${pad(n.getMonth()+1)}/${n.getFullYear()} ${pad(n.getHours())}:${pad(n.getMinutes())}`; }
  function makeReport(item){
    return `BLOC/OPÃ‰RATION:\n- ${item.bloc.join('\n- ')}\n\nPOST-OP / SURVEILLANCE:\n- ${item.postop.join('\n- ')}`;
  }` : '', include.TraumaThorax ? `
Checklist Trauma thorax:
- ${checklists.TraumaThorax.join('
- ')}` : '', include.Brules ? `
Checklist BrÃ»lÃ©s:
- ${checklists.Brules.join('
- ')}` : '' ].filter(Boolean).join('
');
    return `RAPPORT MÃ‰DICAL â€” Chirufunction makeReport(item){
    return `BLOC/OPÃ‰RATION:\n- ${item.bloc.join('\n- ')}\n\nPOST-OP / SURVEILLANCE:\n- ${item.postop.join('\n- ')}`;
  }____________________________________________

CATÃ‰GORIE: ${item.categorie}
CAS: ${item.titre}

EXAMENS:
- ${item.examens.join('
- ')}

GESTES INITIAUX:
- ${item.gestes.join('
- ')}

BLOC/OPÃ‰RATION:
- ${item.bloc.join('
- ')}

POST-OP / SURVEILLANCE:
- ${item.postop.join('
- ')}
${checklistText}

POINTS CLÃ‰S Ã€ DOCUMENTER:
- ${item.rapportPoints.join('
- ')}

Remarques complÃ©mentaires: _____________________________________
Signature: __________`;
  }

  // ------------------------------
  // UI rendering
  // ------------------------------
  const state = { q: '', catFilter: new Set(CATEGORIES), selectedId: null };

  function renderCategories(){
    const box = document.getElementById('catList');
    box.innerHTML = '';
    CATEGORIES.forEach(cat => {
      const id = `cat-${cat.replace(/[^a-z0-9]/gi,'_')}`;
      const row = document.createElement('label');
      row.innerHTML = `<input type="checkbox" id="${id}" ${state.catFilter.has(cat)?'checked':''}/> <span>${cat}</span>`;
      row.addEventListener('change', (e)=>{
        const inp = row.querySelector('input');
        if(inp.checked) state.catFilter.add(cat); else state.catFilter.delete(cat);
        renderResults();
      });
      box.appendChild(row);
    });
  }

  function filterData(){
    const q = state.q.trim().toLowerCase();
    return bank.filter(it => state.catFilter.has(it.categorie) && (!q || it.titre.toLowerCase().includes(q) || it.tags.join(' ').toLowerCase().includes(q)) );
  }

  function skeleton(n=4){
    const t = document.getElementById('skeletonCard');
    const list = document.getElementById('results');
    list.innerHTML = '';
    for(let i=0;i<n;i++){ list.appendChild(t.content.cloneNode(true)); }
  }

  function renderResults(){
    const list = document.getElementById('results');
    list.innerHTML = '';
    const data = filterData();
    if(!data.length){
      const empty = document.createElement('div');
      empty.className = 'card p-6 text-center';
      empty.innerHTML = `<div class="text-lg">ğŸ˜• Aucun rÃ©sultat</div><div class="text-sm mt-1" style="color:var(--muted)">Essaie un autre mot-clÃ© ou active plus de catÃ©gories.</div>`;
      list.appendChild(empty);
      return;
    }
    data.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card p-3';
      card.innerHTML = `
        <div class="text-sm font-semibold">${item.titre}</div>
        <div class="flex flex-wrap gap-1 mt-1">
          <span class="badge">${item.categorie}</span>
          ${item.tags.slice(0,3).map(t => `<span class='badge'>${t}</span>`).join('')}
        </div>
        <div class="flex gap-2 pt-3">
          <button class="btn btn-primary" data-action="compose">ğŸ§¾ Composer rapport</button>
          <button class="btn btn-ghost" data-action="details">ğŸ“‹ Voir dÃ©tails</button>
        </div>
      `;
      card.querySelector('[data-action="compose"]').addEventListener('click', ()=>composeReport(item));
      card.querySelector('[data-action="details"]').addEventListener('click', ()=>showDetails(item));
      list.appendChild(card);
    });
  }

  function showDetails(item){
    state.selectedId = item.id;
    const wrap = document.getElementById('detailsWrap');
    wrap.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'card p-4';
    card.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <h3 class="text-base font-semibold">DÃ©tails â€” ${item.titre}</h3>
        <button class="btn btn-primary" id="btnCompose2">ğŸ§¾ Composer un rapport</button>
      </div>
      <div class="tabs mt-3 flex flex-wrap gap-2">
        <button data-tab="examens" class="active">ğŸ§ª Examens</button>
        <button data-tab="gestes">âœš Gestes</button>
        <button data-tab="bloc">ğŸ› ï¸ Bloc</button>
        <button data-tab="postop">ğŸ’Š Post-op</button>
        <button data-tab="rapport">ğŸ§¾ Rapport</button>
      </div>
      <div id="tabContent" class="mt-3"></div>
      <hr class="my-3" style="border-color:var(--border)"/>
      <p class="text-xs" style="color:var(--muted)">Ajouts automatiques possiblesÂ :</p>
      <div class="grid sm:grid-cols-3 gap-2 mt-1 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" id="incABCDE" ${document.getElementById('ckABCDE').checked?'checked':''}/> Inclure checklist ABCDE</label>
        <label class="flex items-center gap-2"><input type="chs(arr){ return `<ul class='list-dash space-y-1 text-sm'>${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`; }
    function renderTab(name){
      const c = card.querySelector('#tabContent');
      if(name==='examens') c.innerHTML = bullets(item.examens);
      if(name==='gestes')  c.innerHTML = bullets(item.gestes);
      if(name==='bloc')    c.innerHTML = bullets(item.bloc);
      if(name==='postop')  c.innerHTML = bullets(item.postop);
      if(name==='rapport') c.innerHTML = `<p class='text-sm mb-2'>Points clÃ©s Ã  documenter :</p><div class='flex flex-wrap gap-1'>${item.rapportPoints.map(p=>`<span class='badge'>${p}</span>`).join('')}</div>`;
    }
    renderTab('examens');
    wrap.appendChild(card);
    window.scrollTo({ top: card.offsetTop - 80, behavior: 'smooth' });
  }

  function composeReport(item){
    const include = {
      ABCDE: document.getElementById('incABCDE') ? document.getElementById('incABCDE').checked : document.getElementById('ckABCDE').checked,
      TraumaThorax: document.getElementById('incThorax') ? document.getElementById('incThorax').checked : document.getElementById('ckThorax').checked,
      Brules: document.getElementById('incBrules') ? document.getElemeconst text = makeReport(item);});
  document.getElementById('btnReset').addEventListener('click', ()=>{ state.q=''; document.getElementById('q').value=''; state.catFilter = new Set(CATEGORIES); renderCategories(); renderResults(); });
  document.getElementById('btnCopy').addEventListener('click', async ()=>{ try { await navigator.clipboard.writeText(document.getElementById('report').value || ''); } catch{} });
  document.getElementById('btnDownload').addEventListener('click', ()=> blobDownload('rapport_chirurgie_RP.txt', document.getElementById('report').value || ''));
  document.getElementById('btnAllCats').addEventListener('click', ()=>{ state.catFilter = new Set(CATEGORIES); renderCategories(); renderResults(); });

  ;['ckABCDE','ckThorax','ckBrules'].forEach(id => { document.getElementById(id).addEventListener('change', ()=>{ if(state.selectedId){ const item = bank.find(b=>b.id===state.selectedId); if(item) composeReport(item); } }); });

  const cached = localStorage.getItem('gta_rp_chir_report'); if(cached) document.getElementById('report').value = cached;

  // First render with skeleto
