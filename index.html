<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chirurgie Complexe ‚Äî GTA RP</title>
  <!-- Tailwind CDN (runtime) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Petites am√©liorations visuelles */
    .card{ @apply bg-white rounded-2xl shadow-sm border border-slate-200; }
    .btn{ @apply inline-flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-medium border; }
    .btn-primary{ @apply bg-slate-900 text-white border-slate-900; }
    .btn-ghost{ @apply bg-white text-slate-700 border-slate-200; }
    .badge{ @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700 border border-slate-200; }
    .tabs [data-tab]{ @apply px-3 py-1.5 rounded-lg text-sm cursor-pointer; }
    .tabs [data-tab].active{ @apply bg-slate-900 text-white; }
    .list-dash li{ position: relative; padding-left: 1rem; }
    .list-dash li::before{ content: "‚Ä¢"; position: absolute; left: 0; color:#0f172a; }
    .sticky-col{ position: sticky; top: 6rem; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <span class="text-xl">ü©∫</span>
      <h1 class="text-xl font-semibold">Chirurgie Complexe ‚Äî Guide RP</h1>
      <span class="ml-auto badge">H√¥pital ‚Äî GTA RP</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Colonne gauche: recherche + r√©sultats -->
    <section class="lg:col-span-2 space-y-4">
      <div class="card p-4">
        <div class="flex flex-col gap-3">
          <div class="flex gap-2 items-center">
            <div class="relative flex-1">
              <input id="q" class="w-full border rounded-xl px-3 py-2 pl-9" placeholder="Rechercher: fracture, rachis, br√ªlure, valve‚Ä¶" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîé</span>
            </div>
            <button id="btnReset" class="btn btn-ghost">‚Ü∫ R√©initialiser</button>
            <details class="relative">
              <summary class="btn btn-ghost cursor-pointer select-none">üîΩ Cat√©gories</summary>
              <div class="absolute right-0 mt-2 w-64 card p-2 grid gap-1 z-10">
                <div id="catList" class="grid gap-1"></div>
              </div>
            </details>
          </div>

          <div id="results" class="grid md:grid-cols-2 gap-3"></div>

          <div id="detailsWrap"></div>
        </div>
      </div>
    </section>

    <!-- Colonne droite: rapport -->
    <aside class="space-y-4">
      <div class="card p-4 sticky-col">
        <div class="flex items-center gap-2 mb-2">
          <span>üìù</span>
          <h2 class="text-base font-semibold">Rapport m√©dical (g√©n√©rateur)</h2>
        </div>
        <textarea id="report" class="w-full min-h-[380px] border rounded-xl p-3 font-mono" placeholder="Clique sur \"Composer rapport\" depuis une fiche pour pr√©-remplir ici‚Ä¶"></textarea>
        <div class="flex gap-2 justify-end mt-2">
          <button id="btnCopy" class="btn btn-ghost">üìã Copier</button>
          <button id="btnDownload" class="btn btn-primary">‚¨áÔ∏è T√©l√©charger</button>
        </div>
        <hr class="my-3" />
        <div>
          <p class="text-sm font-medium">Inclure des checklists</p>
          <label class="flex items-center gap-2 text-sm mt-1"><input type="checkbox" id="ckABCDE" checked> ABCDE</label>
          <label class="flex items-center gap-2 text-sm mt-1"><input type="checkbox" id="ckThorax"> Trauma thorax</label>
          <label class="flex items-center gap-2 text-sm mt-1"><input type="checkbox" id="ckBrules"> Br√ªl√©s</label>
        </div>
      </div>
    </aside>
  </main>

  <footer class="max-w-7xl mx-auto px-4 pb-8 text-xs text-slate-500">
    <hr class="mb-3 border-slate-200" />
    ‚ö†Ô∏è Outil de jeu ‚Äî GTA RP. Proc√©dures simplifi√©es et non prescriptives. Ce contenu ne constitue pas un conseil m√©dical r√©el.
  </footer>

  <script>
  // ------------------------------
  // Donn√©es (synth√®se RP)
  // ------------------------------
  const CATEGORIES = [
    "Orthop√©die/Os",
    "Cr√¢ne/Neurochir",
    "Rachis",
    "Muscles/Tendons",
    "Thorax",
    "Cardiaque",
    "Visc√©ral/Abdomen",
    "Grands br√ªl√©s",
    "Neurologie traumatique",
  ];

  const bank = [
    {
      id: "os-fix",
      titre: "R√©paration osseuse (broches/vis/plaques/p√¢te)",
      categorie: "Orthop√©die/Os",
      tags: ["fracture", "broches", "vis", "plaques", "p√¢te osseuse"],
      examens: [
        "Inspection + douleur provoqu√©e, d√©formation, plaie ouverte",
        "Contr√¥le vasculo-nerveux distal (pouls, sensibilit√©, motricit√©)",
        "Immobilisation provisoire (attelle) avant transport",
        "Imagerie RP: radio/scan si dispo en service",
      ],
      gestes: [
        "H√©mostase locale si plaie",
        "Attelle modelable, glace externe",
        "Antalgie non chiffr√©e (RP)",
        "Transport vers bloc si fracture instable/ouverte",
      ],
      bloc: [
        "Broches/clous IM: r√©alignement + verrouillage",
        "Plaques + vis anatomiques si fracture articulaire/complexe",
        "P√¢te/greffe osseuse si perte de substance",
      ],
      postop: [
        "Contr√¥le vasculo-nerveux post-immobilisation",
        "Imagerie de contr√¥le",
        "D√©charge/b√©quilles selon segment",
      ],
      rapportPoints: ["Os concern√©", "Type de fracture", "Gestes d'urgence", "Fixation r√©alis√©e", "Surveillance"],
    },
    {
      id: "crane",
      titre: "Chirurgie cr√¢nienne (craniotomie / cr√¢nioplastie)",
      categorie: "Cr√¢ne/Neurochir",
      tags: ["TCC", "h√©matome", "craniotomie", "cr√¢nioplastie", "plaques cr√¢niennes"],
      examens: [
        "Score de Glasgow, pupilles, d√©ficit focal",
        "Stabilisation cervicale jusqu'√† imagerie",
        "Scan cr√¢ne si dispo (RP)",
      ],
      gestes: [
        "ABCDE avec surveillance G",
        "Oxyg√©nation, contr√¥le des convulsions si besoin (RP)",
        "Pr√©paration bloc si h√©matome compressif",
      ],
      bloc: [
        "Craniotomie: volet + √©vacuation h√©matome",
        "Plaques/vis titane pour refixation",
        "Cr√¢nioplastie ou ciment (PMMA/hydroxyapatite) si d√©faut",
      ],
      postop: [
        "Surveillance neuro rapproch√©e",
        "Scan de contr√¥le",
        "Pr√©vention infection",
      ],
      rapportPoints: ["M√©canisme", "Glasgow", "L√©sions scan", "Geste neurochir", "√âvolution imm√©diate"],
    },
    {
      id: "rachis",
      titre: "Rachis (discectomie, laminectomie, fusion, foraminotomie)",
      categorie: "Rachis",
      tags: ["rachis", "hernie discale", "st√©nose", "fracture", "scoliose"],
      examens: [
        "Immobilisation stricte du rachis",
        "√âvaluation sensitivo-motrice et p√©rin√©e",
        "Scan/IRM selon RP",
      ],
      gestes: [
        "Collier + plan dur",
        "Antalgie prudente (RP)",
        "Transport bloc si d√©ficit √©volutif/instabilit√©",
      ],
      bloc: [
        "Discectomie si conflit disque-nerf",
        "Laminectomie pour d√©compression",
        "Fusion + vis/tiges, cage si instabilit√©",
      ],
      postop: ["Surveillance neuro", "Mobilisation encadr√©e", "Imagerie de contr√¥le"],
      rapportPoints: ["Niveau l√©sionnel", "D√©ficit", "Imagerie", "Geste r√©alis√©", "Stabilit√© finale"],
    },
    {
      id: "muscle",
      titre: "Rupture musculaire (partielle/compl√®te)",
      categorie: "Muscles/Tendons",
      tags: ["d√©chirure", "rupture", "suture musculaire", "r√©√©ducation"],
      examens: [
        "Douleur localis√©e, h√©matome, d√©ficit fonctionnel",
        "√âchelle douleur RP",
        "√âchographie si dispo",
      ],
      gestes: ["Repos, glace, compression, √©l√©vation (RICE)", "Immobilisation courte", "Antalgie RP"],
      bloc: ["Suture des berges musculaires", "Renfort tendineux si besoin"],
      postop: ["Immobilisation initiale", "Mobilisation douce", "Renforcement progressif"],
      rapportPoints: ["Muscle atteint", "Type (partielle/compl√®te)", "Gestes d'urgence", "R√©paration", "Programme r√©hab"],
    },
    {
      id: "thorax",
      titre: "Chirurgie thoracique (lobe, m√©diastin, trach√©e, trauma)",
      categorie: "Thorax",
      tags: ["lobectomie", "pneumothorax", "h√©mothorax", "d√©cortication", "trach√©otomie"],
      examens: ["D√©tresse respi?", "Auscultation, saturation", "√âcho FAST/Radio si dispo"],
      gestes: [
        "Aiguille d√©compression si pneumo sous tension (RP)",
        "Drain thoracique si indiqu√© (RP)",
        "Oxyg√®ne et analg√©sie RP",
      ],
      bloc: [
        "Lobectomie/segmentectomie selon l√©sion",
        "D√©cortication pleurale",
        "Trach√©otomie si voie a√©rienne compromise",
      ],
      postop: ["Surveillance respi + drains", "Kin√© respi", "Contr√¥le fuites d'air"],
      rapportPoints: ["M√©canisme/Pathologie", "C√¥t√© atteint", "Gestes pr√©hospitaliers", "Geste thoracique", "Drains"]
    },
    {
      id: "cardiaque",
      titre: "Cardiaque (pontage, valves, FA, DAV)",
      categorie: "Cardiaque",
      tags: ["pontage", "valve", "FA", "transplantation", "DAV"],
      examens: ["Douleur thoracique?", "ECG si RP", "√âcho si dispo"],
      gestes: ["ABCDE + O2 si SpO2 basse", "Anti-douleur RP", "Pr√©pa bloc si instabilit√©"],
      bloc: ["Pontage coronarien", "R√©paration/remplacement valvulaire", "Ablation/MAZE", "Implant DAV"],
      postop: ["Surveillance en USIC/REA", "Pr√©vention infection", "R√©√©ducation cardiaque"],
      rapportPoints: ["Diagnostic", "Geste cardiaque", "CPEC (REA/USIC)", "√âvolution"],
    },
    {
      id: "visc",
      titre: "Visc√©ral/Abdomen (appendice, v√©sicule, hernie, r√©section‚Ä¶)",
      categorie: "Visc√©ral/Abdomen",
      tags: ["appendicite", "v√©sicule", "hernie", "r√©section", "gastrectomie", "bariatrique", "foie", "pancr√©as", "rate"],
      examens: ["Douleur, d√©fense/contracture", "N/V, transit", "FAST/Scan RP"],
      gestes: ["Je√ªne + VVP (RP)", "Antalgie RP", "Pr√©paration bloc si abdomen aigu/trauma"],
      bloc: [
        "Appendicectomie (souvent coelio)",
        "Chol√©cystectomie coelio",
        "Herniorraphie/mesh",
        "R√©section intestinale ¬± stomie",
        "Gastrectomie / sleeve",
        "H√©patectomie partielle",
        "Pancr√©atectomie (Whipple/distale)",
        "Spl√©nectomie",
      ],
      postop: ["Surveillance souillures/saignement", "Reprise du transit", "Douleur"],
      rapportPoints: ["Organe", "Diagnostic", "Voie d'abord", "Geste", "Suites"],
    },
    {
      id: "brules",
      titre: "Grands br√ªl√©s",
      categorie: "Grands br√ªl√©s",
      tags: ["SCB", "Parkland", "greffe peau", "d√©bridement"],
      examens: [
        "√âvaluer profondeur + %SCB (r√®gle des 9 / Lund-Browder RP)",
        "Voies a√©riennes (inhalation?)",
      ],
      gestes: [
        "Refroidir (pas de glace directe prolong√©e)",
        "Retirer v√™tements/objets chauds",
        "Voie veineuse, r√©animation liquidienne (RP, formule de Parkland en info seulement)",
        "Antalgie RP",
      ],
      bloc: ["D√©bridement", "Greffes cutan√©es", "Pansements sp√©cifiques"],
      postop: ["Kin√© + orth√®ses", "Suivi psycho", "Gestion cicatrices"],
      rapportPoints: ["M√©canisme", "%SCB estim√©e", "Zones atteintes", "Gestes/initiaux", "Greffes"],
    },
    {
      id: "neurotrauma",
      titre: "Neurologie traumatique (TCC, moelle, nerfs p√©riph.)",
      categorie: "Neurologie traumatique",
      tags: ["TCC", "l√©sion m√©dullaire", "p√©riph√©rique", "d√©compression"],
      examens: ["ABCDE + Glasgow", "Immobilisation rachis", "Scan/IRM RP"],
      gestes: ["Stabiliser VA/O2", "Pr√©venir hypotension/hypoxie", "Transport rapide vers sp√©cialit√©"],
      bloc: ["Craniotomie d√©compressive", "Fixation rachidienne", "R√©paration nerveuse"],
      postop: ["R√©√©ducation pluridisciplinaire", "Pr√©vention escarres/TVP", "Suivi long cours"],
      rapportPoints: ["Type l√©sion", "Score GCS", "Gestes d'urgence", "Chirurgie", "Plan r√©hab"],
    },
  ];

  const checklists = {
    ABCDE: [
      "A ‚Äî Airway: perm√©abilit√©, collier si trauma",
      "B ‚Äî Breathing: FR, SpO2, auscultation, d√©compression si tension (RP)",
      "C ‚Äî Circulation: pouls, h√©morragies, perfusion",
      "D ‚Äî Disability: Glasgow, pupilles, d√©ficit",
      "E ‚Äî Exposure: d√©shabiller, temp√©rature, l√©sions",
    ],
    TraumaThorax: [
      "Inspection cage (emphys√®me SC, volet costal)",
      "Percussion (hyper/tympanisme)",
      "Auscultation (asym√©trie)",
      "Si d√©tresse + d√©viation trach√©ale ‚áí d√©compression (RP)",
    ],
    Brules: [
      "Arr√™t agent vuln√©rant, refroidissement 10-20 min",
      "√âvaluer %SCB (RP)",
      "Voies a√©riennes: suspicion inhalation",
      "Couvrir st√©rile/film alimentaire (RP)",
    ],
  };

  // ------------------------------
  // Helpers
  // ------------------------------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function cx(...c){ return c.filter(Boolean).join(' '); }

  function blobDownload(filename, text){
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function formatDate(){
    const n = new Date();
    const pad = (x)=> String(x).padStart(2,'0');
    return `${pad(n.getDate())}/${pad(n.getMonth()+1)}/${n.getFullYear()} ${pad(n.getHours())}:${pad(n.getMinutes())}`;
  }

  function makeReport(item, include){
    const checklistText = [
      include.ABCDE ? `\nChecklist ABCDE:\n- ${checklists.ABCDE.join('\n- ')}` : '',
      include.TraumaThorax ? `\nChecklist Trauma thorax:\n- ${checklists.TraumaThorax.join('\n- ')}` : '',
      include.Brules ? `\nChecklist Br√ªl√©s:\n- ${checklists.Brules.join('\n- ')}` : '',
    ].filter(Boolean).join('\n');

    return `RAPPORT M√âDICAL ‚Äî Chirurgie complexe (RP)\nDate/Heure: ${formatDate()}\n\nPatient: __________________  √Çge: __  Sexe: __  ID RP: ________\nM√©ca/Contexte: _________________________________________________\n\nCAT√âGORIE: ${item.categorie}\nCAS: ${item.titre}\n\nEXAMENS:\n- ${item.examens.join('\n- ')}\n\nGESTES INITIAUX:\n- ${item.gestes.join('\n- ')}\n\nBLOC/OP√âRATION:\n- ${item.bloc.join('\n- ')}\n\nPOST-OP / SURVEILLANCE:\n- ${item.postop.join('\n- ')}\n${checklistText}\n\nPOINTS CL√âS √Ä DOCUMENTER:\n- ${item.rapportPoints.join('\n- ')}\n\nRemarques compl√©mentaires: _____________________________________\nSignature: __________`;
  }

  // ------------------------------
  // UI rendering
  // ------------------------------
  const state = {
    q: '',
    catFilter: new Set(CATEGORIES),
    selectedId: null,
  };

  function renderCategories(){
    const box = $('#catList');
    box.innerHTML = '';
    CATEGORIES.forEach(cat => {
      const id = `cat-${cat.replace(/[^a-z0-9]/gi,'_')}`;
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 text-sm px-2 py-1 rounded hover:bg-slate-50';
      row.innerHTML = `<input type="checkbox" id="${id}" ${state.catFilter.has(cat)?'checked':''}/> <span>${cat}</span>`;
      row.querySelector('input').addEventListener('change', (e)=>{
        if(e.target.checked) state.catFilter.add(cat); else state.catFilter.delete(cat);
        renderResults();
      });
      box.appendChild(row);
    });
  }

  function filterData(){
    const q = state.q.trim().toLowerCase();
    return bank.filter(it => state.catFilter.has(it.categorie) && (!q || it.titre.toLowerCase().includes(q) || it.tags.join(' ').toLowerCase().includes(q)) );
  }

  function renderResults(){
    const list = $('#results');
    list.innerHTML = '';
    const data = filterData();
    data.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card p-3';
      card.innerHTML = `
        <div class="text-sm font-semibold">${item.titre}</div>
        <div class="flex flex-wrap gap-1 mt-1">
          <span class="badge">${item.categorie}</span>
          ${item.tags.slice(0,3).map(t => `<span class='badge'>${t}</span>`).join('')}
        </div>
        <div class="flex gap-2 pt-2">
          <button class="btn btn-primary" data-action="compose">üßæ Composer rapport</button>
          <button class="btn btn-ghost" data-action="details">üìã Voir d√©tails</button>
        </div>
      `;
      card.querySelector('[data-action="compose"]').addEventListener('click', ()=>composeReport(item));
      card.querySelector('[data-action="details"]').addEventListener('click', ()=>showDetails(item));
      list.appendChild(card);
    });
  }

  function showDetails(item){
    state.selectedId = item.id;
    const wrap = $('#detailsWrap');
    wrap.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'card p-4';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <h3 class="text-base font-semibold">D√©tails ‚Äî ${item.titre}</h3>
        <button class="btn btn-primary" id="btnCompose2">üßæ Composer un rapport</button>
      </div>
      <div class="tabs mt-3 flex flex-wrap gap-2">
        <button data-tab="examens" class="active">Examens</button>
        <button data-tab="gestes">Gestes</button>
        <button data-tab="bloc">Bloc</button>
        <button data-tab="postop">Post-op</button>
        <button data-tab="rapport">Rapport</button>
      </div>
      <div id="tabContent" class="mt-3"></div>
      <hr class="my-3"/>
      <p class="text-xs text-slate-500">Ajouts automatiques possibles¬†:</p>
      <div class="grid sm:grid-cols-3 gap-2 mt-1 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" id="incABCDE" ${$('#ckABCDE').checked?'checked':''}/> Inclure checklist ABCDE</label>
        <label class="flex items-center gap-2"><input type="checkbox" id="incThorax" ${$('#ckThorax').checked?'checked':''}/> Inclure checklist Trauma thorax</label>
        <label class="flex items-center gap-2"><input type="checkbox" id="incBrules" ${$('#ckBrules').checked?'checked':''}/> Inclure checklist Br√ªl√©s</label>
      </div>
    `;
    card.querySelector('#btnCompose2').addEventListener('click', ()=>composeReport(item));
    const tabs = card.querySelectorAll('[data-tab]');
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderTab(btn.getAttribute('data-tab'));
    }));

    function renderTab(name){
      const c = card.querySelector('#tabContent');
      const bullets = (arr)=> `<ul class='list-dash space-y-1 text-sm'>${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`;
      if(name==='examens') c.innerHTML = bullets(item.examens);
      if(name==='gestes')  c.innerHTML = bullets(item.gestes);
      if(name==='bloc')    c.innerHTML = bullets(item.bloc);
      if(name==='postop')  c.innerHTML = bullets(item.postop);
      if(name==='rapport') c.innerHTML = `
        <p class='text-sm mb-2'>Points cl√©s √† documenter :</p>
        <div class='flex flex-wrap gap-1'>${item.rapportPoints.map(p=>`<span class='badge'>${p}</span>`).join('')}</div>
      `;
    }
    renderTab('examens');
    wrap.appendChild(card);
    window.scrollTo({ top: card.offsetTop - 80, behavior: 'smooth' });
  }

  function composeReport(item){
    const include = {
      ABCDE: $('#incABCDE') ? $('#incABCDE').checked : $('#ckABCDE').checked,
      TraumaThorax: $('#incThorax') ? $('#incThorax').checked : $('#ckThorax').checked,
      Brules: $('#incBrules') ? $('#incBrules').checked : $('#ckBrules').checked,
    };
    const text = makeReport(item, include);
    const ta = $('#report');
    ta.value = text;
    localStorage.setItem('gta_rp_chir_report', text);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ------------------------------
  // Events init
  // ------------------------------
  $('#q').addEventListener('input', (e)=>{ state.q = e.target.value; renderResults(); });
  $('#btnReset').addEventListener('click', ()=>{ state.q=''; $('#q').value=''; state.catFilter = new Set(CATEGORIES); renderCategories(); renderResults(); });

  $('#btnCopy').addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText($('#report').value || ''); } catch{}
  });
  $('#btnDownload').addEventListener('click', ()=> blobDownload('rapport_chirurgie_RP.txt', $('#report').value || ''));

  // checkbox defaults
  ['ckABCDE','ckThorax','ckBrules'].forEach(id => {
    $('#'+id).addEventListener('change', ()=>{
      if(state.selectedId){
        const item = bank.find(b=>b.id===state.selectedId);
        if(item) composeReport(item);
      }
    });
  });

  // Restore cached report
  const cached = localStorage.getItem('gta_rp_chir_report');
  if(cached) $('#report').value = cached;

  // First render
  renderCategories();
  renderResults();
  </script>
</body>
</html>
