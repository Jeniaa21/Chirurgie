<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chirurgie Complexe ‚Äî GTA RP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' };</script>
  <style>
    :root { --bg:#f8fafc; --panel:#ffffff; --border:#e2e8f0; --text:#0f172a; --muted:#64748b; --chip:#f1f5f9; --shadow:0 8px 24px rgba(2,6,23,.06); --ring:rgba(15,23,42,.12); --accent:#0f172a; }
    .dark { --bg:#0b1220; --panel:#0f172a; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --chip:#111827; --shadow:0 8px 24px rgba(0,0,0,.35); --ring:rgba(148,163,184,.2); --accent:#38bdf8; }
    body { background:var(--bg); color:var(--text); }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:1rem; box-shadow:var(--shadow); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.75rem; border:1px solid var(--border); font-weight:600; font-size:.9rem; }
    .btn:hover{ box-shadow:0 0 0 6px var(--ring); }
    .btn-primary{ background:var(--accent); color:white; border-color:var(--accent); }
    .btn-ghost{ background:var(--panel); color:var(--text); }
    .badge{ display:inline-flex; align-items:center; padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; border:1px solid var(--border); background:var(--chip); color:var(--muted); }
    .tabs button{ padding:.4rem .75rem; border-radius:.6rem; font-weight:600; font-size:.9rem; color:var(--muted); }
    .tabs button.active{ background:var(--accent); color:white; }
    .list-dash li{ position:relative; padding-left:1rem; }
    .list-dash li::before{ content:"‚Ä¢"; position:absolute; left:0; color:var(--accent); }
    .sticky-col{ position:sticky; top:6rem; }
    .field{ border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:.75rem; padding:.6rem .75rem; }
    .menu{ border:1px solid var(--border); background:var(--panel); border-radius:.75rem; box-shadow:var(--shadow); }
    .hint{ color:var(--muted); }
  </style>
</head>
<body>
  <header class="sticky top-0 z-30 backdrop-blur border-b" style="background:color-mix(in oklab,var(--panel) 80%, transparent)">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ü©∫</span>
        <h1 class="text-lg md:text-xl font-semibold">Chirurgie Complexe ‚Äî Guide RP</h1>
      </div>
      <span class="ml-auto badge">H√¥pital ‚Äî GTA RP</span>
      <button id="themeToggle" class="btn btn-ghost ml-2" title="Mode sombre (t)">üåó <span class="hidden md:inline">Th√®me</span></button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 space-y-4">
      <div class="card p-4">
        <div class="flex flex-col gap-4">
          <div class="flex flex-wrap gap-2 items-center">
            <div class="relative grow">
              <input id="q" class="field pl-10 w-full" placeholder="Rechercher: fracture, rachis, br√ªlure, valve‚Ä¶" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üîé</span>
            </div>
            <button id="btnReset" class="btn btn-ghost">‚Ü∫ R√©initialiser</button>
          </div>
          <div id="results" class="grid md:grid-cols-2 gap-3"></div>
          <div id="detailsWrap"></div>
        </div>
      </div>
    </section>

    <aside class="space-y-4">
      <div class="card p-4 sticky-col">
        <div class="flex items-center gap-2 mb-2">
          <span>üìù</span>
          <h2 class="text-base font-semibold">Rapport m√©dical (g√©n√©rateur)</h2>
        </div>
        <textarea id="report" class="w-full min-h-[380px] field font-mono" placeholder="Clique sur 'Composer' puis choisis le type d'intervention‚Ä¶"></textarea>
        <div class="flex gap-2 justify-end mt-2">
          <button id="btnCopy" class="btn btn-ghost">üìã Copier</button>
          <button id="btnDownload" class="btn btn-primary">‚¨áÔ∏è T√©l√©charger</button>
        </div>
        <hr class="my-3" style="border-color:var(--border)" />
        <p class="text-sm hint">
          Le rapport contient uniquement : <b>BLOC/OP√âRATION</b> et <b>POST-OP / SURVEILLANCE</b>. S√©lectionne un <b>type d'intervention</b> dans la fiche pour un rapport plus pr√©cis.
        </p>
      </div>
    </aside>
  </main>

  <footer class="max-w-7xl mx-auto px-4 pb-8 text-xs hint">
    <hr class="mb-3" style="border-color:var(--border)" />
    ‚ö†Ô∏è Outil de jeu ‚Äî GTA RP. Proc√©dures simplifi√©es et non prescriptives. Ce contenu ne constitue pas un conseil m√©dical r√©el.
  </footer>

  <script>
  // Th√®me
  const root = document.documentElement; const THEME_KEY='gta_rp_theme';
  function setTheme(m){ if(m==='dark'){ root.classList.add('dark'); localStorage.setItem(THEME_KEY,'dark'); } else { root.classList.remove('dark'); localStorage.setItem(THEME_KEY,'light'); } }
  (function(){ const saved = localStorage.getItem(THEME_KEY); if(saved) setTheme(saved); else if(window.matchMedia('(prefers-color-scheme: dark)').matches) setTheme('dark'); })();
  document.getElementById('themeToggle').onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='t') document.getElementById('themeToggle').click(); });

  // Donn√©es
  const bank = [
    {
      id:'visc', categorie:'Visc√©ral/Abdomen', titre:'Visc√©ral/Abdomen (appendice, v√©sicule, hernie, r√©section‚Ä¶)',
      bloc:["Appendicectomie (souvent coelio)","Chol√©cystectomie coelio","Herniorraphie/mesh","R√©section intestinale ¬± stomie","Gastrectomie / sleeve","H√©patectomie partielle","Pancr√©atectomie","Spl√©nectomie"],
      postop:["Surveillance souillures/saignement","Reprise du transit","Douleur"],
      procedures:[
        {id:'appendicectomie', label:'Appendicectomie', bloc:["Voie: coelioscopie","Ligature/section appendice (endoloop/agrafe)","Lavage si p√©ritonite","Extraction endobag"], postop:["Douleur/fi√®vre","Reprise du transit","R√©gime progressif"]},
        {id:'cholecystectomie', label:'Chol√©cystectomie', bloc:["Coelioscopie","Dissection triangle de Calot","Clipage canal cystique + art√®re cystique","Extraction v√©sicule"], postop:["Surveillance douleur/ict√®re","Tol√©rance alimentaire","Contr√¥le des drains si pos√©s"]},
        {id:'hernie', label:'Herniorraphie/Hernioplastie', bloc:["R√©int√©gration sac herniaire","Fermeture orifice","Pose proth√®se (mesh) pr√©/retro-p√©riton√©ale"], postop:["Douleur locale","Surveillance h√©matome","Repos/√©viter port de charges"]},
        {id:'resection', label:'R√©section intestinale', bloc:["R√©section segmentaire","Anastomose termino-terminale (ou lat√©ro-lat√©rale)","Stomie de d√©rivation si besoin"], postop:["Transit, gaz/selles","D√©bit drains","Fi√®vre/abdomen sensible"]},
        {id:'gastrectomie', label:'Gastrectomie', bloc:["Partielle ou totale selon l√©sion","Curage ganglionnaire si oncologique","Reconstruction: Billroth II ou Roux-en-Y"], postop:["SNG √©ventuelle","Surveillance fistule (tachy, fi√®vre, drainage)","Reprise PO progressive","Pr√©vention carences (B12 si totale)"]},
        {id:'bariatrique', label:'Chirurgie bariatrique (sleeve/bypass)', bloc:["Calibration bougie","Agrafage longitudinal (sleeve)","Test d'√©tanch√©it√©","Bypass: petite poche + anse aliment + anse bilio-pancr√©atique"], postop:["Fuites/h√©morragie","Hydratation fractionn√©e","Suivi di√©t√©tique"]},
        {id:'hepatectomie', label:'H√©patectomie', bloc:["R√©section segmentaire/lobectomie","Contr√¥le p√©diculaire (clampage/pringle)","H√©mostase/colle + drainage"], postop:["HB/INR/bilirubine","D√©bit drains","Signes h√©morragiques"]},
        {id:'pancreatectomie', label:'Pancr√©atectomie (Whipple/distale)', bloc:["Whipple: c√©phalique avec anastomoses","Distale ¬± spl√©nectomie","H√©mostase m√©ticuleuse"], postop:["Fistule pancr√©atique (amylase drain)","Glyc√©mie","Douleur/NA"]},
        {id:'splenectomie', label:'Spl√©nectomie', bloc:["Ligature p√©dicule spl√©nique","Extraction","Pr√©servation/section des courts vaisseaux"], postop:["Surveillance saignement","Vaccinations (info RP)","Douleur"]}
      ]
    },
    {
      id:'thorax', categorie:'Thorax', titre:'Chirurgie thoracique (lobe, m√©diastin, trach√©e, trauma)',
      bloc:["Lobectomie/segmentectomie","D√©cortication pleurale","Trach√©otomie"],
      postop:["Surveillance respi + drains","Kin√© respi","Fuites d'air"],
      procedures:[
        {id:'lobectomie', label:'Lobectomie', bloc:["VATS/Thoracotomie","Section art√®re/veine/bronche du lobe","Retrait lobe + contr√¥le h√©mostase"], postop:["SpO2, douleur","D√©bit et bullage drains","Kin√©sith√©rapie"]},
        {id:'pneumonectomie', label:'Pneumonectomie', bloc:["Ligature vaisseaux pulmonaires","Section bronche principale","Fermeture moignon"], postop:["Surveillance d√©viation m√©diastin","Balance hydrique stricte","Douleur"]},
        {id:'decortication', label:'D√©cortication pleurale', bloc:["Ouverture thorax","Ablation coque fibreuse","R√©-expansion pulmonaire"], postop:["D√©bit drain","Fi√®vre/infection","SpO2"]},
        {id:'tracheotomie', label:'Trach√©otomie', bloc:["Incision trach√©ale","Mise en place canule","Fixation"], postop:["Soins canule","Aspirations","Surveillance saignement"]},
        {id:'oesophagectomie', label:"≈ísophagectomie", bloc:["Voies abdomino-thoraciques","R√©section ≈ìsophage","Ascension estomac + anastomose"], postop:["Fistule anastomotique","Nutrition ent√©rale","KTJ si n√©cessaire"]}
      ]
    },
    {
      id:'os-fix', categorie:'Orthop√©die/Os', titre:'R√©paration osseuse (broches/vis/plaques/p√¢te)',
      bloc:["Broches/clous IM","Plaques + vis","P√¢te/greffe osseuse"],
      postop:["Contr√¥le vasculo-nerveux","Imagerie","D√©charge/b√©quilles"],
      procedures:[
        {id:'broches', label:'Broches / clous IM', bloc:["Incision + entr√©e canal m√©dullaire","R√©duction fracture","Insertion clou + verrouillage prox/ dist"], postop:["Contr√¥le V/N distal","Radio de contr√¥le","Appui selon indication"]},
        {id:'vis', label:'Vis', bloc:["Forage/mesure","Pose vis perpendiculaire au trait","Contr√¥le stabilit√©"], postop:["Douleur/≈ìd√®me","Radio","Protection segment"]},
        {id:'plaques', label:'Plaques', bloc:["Exposition fracture","Plaque anatomique + vis verrouill√©es","Contr√¥le alignement"], postop:["Radio","Mobilisation encadr√©e","Surveillance cicatrice"]},
        {id:'pate', label:'P√¢te/greffe osseuse', bloc:["Pr√©paration site","Comblement d√©faut osseux","Stabilisation associ√©e"], postop:["Consolidation radiologique","Appui progressif","Douleur"]}
      ]
    },
    {
      id:'crane', categorie:'Cr√¢ne/Neurochir', titre:'Chirurgie cr√¢nienne (craniotomie / cr√¢nioplastie)',
      bloc:["Craniotomie","Plaques/vis titane","Cr√¢nioplastie/ciment"], postop:["Surveillance neuro","Scan de contr√¥le","Pr√©vention infection"],
      procedures:[
        {id:'craniotomie', label:'Craniotomie', bloc:["Volet osseux","√âvacuation h√©matome/l√©sion","Refixation volet (plaques/vis)"], postop:["GCS/pupilles","TDM de contr√¥le","Antibioprophylaxie selon protocole (RP)"]},
        {id:'cranioplastie', label:'Cr√¢nioplastie', bloc:["Pr√©paration d√©faut osseux","Implant (autogreffe/titane/PMMA)","Fixation"], postop:["Infection/collection","Esth√©tique/relief","Scan si besoin"]}
      ]
    },
    {
      id:'rachis', categorie:'Rachis', titre:'Rachis (discectomie, laminectomie, fusion, foraminotomie)',
      bloc:["Discectomie","Laminectomie","Fusion"], postop:["Surveillance neuro","Mobilisation","Contr√¥le imagerie"],
      procedures:[
        {id:'discectomie', label:'Discectomie', bloc:["Voie post√©rieure/ant√©rieure","Ablation fragment discal","D√©compression racine"], postop:["Douleur radiculaire","Mobilisation prudente","Soin cicatrice"]},
        {id:'laminectomie', label:'Laminectomie', bloc:["R√©section lame vert√©brale","D√©compression canal","H√©mostase"], postop:["D√©ficit moteur/sensoriel","Douleur","Mobilisation"]},
        {id:'fusion', label:'Fusion vert√©brale', bloc:["Pr√©paration intersomatique","Greffon/cage","Vis/tiges"], postop:["Corset si indiqu√©","Restriction mouvements","Consolidation radio"]},
        {id:'foraminotomie', label:'Foraminotomie', bloc:["Agrandissement foramen","Ablation ost√©ophytes","Lib√©ration racine"], postop:["Douleur/paresth√©sies","Mobilisation","Soin cicatrice"]}
      ]
    },
    { id:'muscle', categorie:'Muscles/Tendons', titre:'Rupture musculaire (partielle/compl√®te)', bloc:["Suture des berges","Renfort tendineux"], postop:["Immobilisation","Mobilisation douce","Renforcement"] },
    { id:'cardiaque', categorie:'Cardiaque', titre:'Cardiaque (pontage, valves, FA, DAV)', bloc:["Pontage","Valve","Ablation/MAZE","DAV"], postop:["REA/USIC","Infection","R√©√©ducation"],
      procedures:[
        {id:'pontage', label:'Pontage coronarien', bloc:["Sternotomie","Greffe mammaire/saph√®ne","D√©rivation des st√©noses"], postop:["Douleur sternale","Drainages","Reprise marche"]},
        {id:'valve', label:'Remplacement/R√©paration valvulaire', bloc:["Exposition valve","R√©paration ou proth√®se","Test de fuite"], postop:["Anticoagulation (info RP)","√âcho de contr√¥le","Infection"]},
        {id:'maze', label:'FA ‚Äî Maze/Ablation', bloc:["L√©sions de blocage oreillettes","¬± Clip oreillette gauche","Contr√¥le rythme"], postop:["Rythme/ECG","Anticoag selon protocole","Douleur"]},
        {id:'dav', label:"Dispositif d'assistance ventriculaire", bloc:["Implantation pompe","Connexion apex/aorte","R√©glages"], postop:["Anticoagulation","Soins driveline","√âducation patient"]}
      ]
    },
    { id:'brules', categorie:'Grands br√ªl√©s', titre:'Grands br√ªl√©s', bloc:["D√©bridement","Greffes cutan√©es","Pansements"], postop:["Kin√©/orth√®ses","Suivi psycho","Cicatrices"] },
    { id:'neurotrauma', categorie:'Neurologie traumatique', titre:'Neurologie traumatique (TCC, moelle, nerfs p√©riph.)', bloc:["Craniotomie d√©compressive","Fixation rachidienne","R√©paration nerveuse"], postop:["R√©√©ducation","Pr√©vention escarres/TVP","Suivi long cours"] }
  ];

  const $ = (s)=>document.querySelector(s);
  function blobDownload(filename, text){ const blob = new Blob([text], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

  function makeReport(item, selectedProcId){
    const proc = (item.procedures||[]).find(p=>p.id===selectedProcId);
    const bloc = proc? proc.bloc : item.bloc;
    const postop = proc? proc.postop : item.postop;
    const titleLine = proc? `Type d'intervention : ${proc.label}\n\n` : '';
    return `${titleLine}BLOC/OP√âRATION:\n- ${bloc.join('\n- ')}\n\nPOST-OP / SURVEILLANCE:\n- ${postop.join('\n- ')}`;
  }

  const state = { q:'', selectedId:null, selectedProc:{} };
  function filterData(){ const q=state.q.trim().toLowerCase(); return bank.filter(it=>!q || it.titre.toLowerCase().includes(q) || it.categorie.toLowerCase().includes(q)); }

  function renderResults(){
    const list=$('#results'); list.innerHTML='';
    const data=filterData();
    if(!data.length){ list.innerHTML='<div class="card p-6 text-center">Aucun r√©sultat trouv√©</div>'; return; }
    data.forEach(item=>{
      const card=document.createElement('div'); card.className='card p-3';
      card.innerHTML=`<div class='text-sm font-semibold'>${item.titre}</div><div class='flex flex-wrap gap-1 mt-1'><span class='badge'>${item.categorie}</span></div><div class='flex gap-2 pt-3'><button class='btn btn-primary'>üßæ Composer</button><button class='btn btn-ghost'>üìã Voir</button></div>`;
      card.querySelector('.btn-primary').onclick=()=>composeReport(item);
      card.querySelector('.btn-ghost').onclick=()=>showDetails(item);
      list.appendChild(card);
    });
  }

  function showDetails(item){
    state.selectedId=item.id;
    const wrap=$('#detailsWrap'); wrap.innerHTML='';
    const card=document.createElement('div'); card.className='card p-4';
    card.innerHTML=`
      <div class='flex items-center justify-between gap-2'>
        <h3 class='text-base font-semibold'>${item.titre}</h3>
        <button class='btn btn-primary' id='btnCompose2'>üßæ Composer</button>
      </div>
      ${(item.procedures&&item.procedures.length)?`<div class='mt-3'>
        <div class='text-sm font-semibold mb-1'>Type d'intervention</div>
        <div id='procList' class='grid sm:grid-cols-2 gap-2'></div>
        <div class='flex gap-2 mt-2'>
          <button class='btn btn-ghost' id='btnClearProc'>Effacer la s√©lection</button>
          <span class='hint text-sm'>Ex.: Visc√©ral/Abdomen ‚Üí coche <b>Gastrectomie</b> pour un rapport cibl√©.</span>
        </div>
      </div>`:''}
      <div class='tabs mt-4 flex flex-wrap gap-2'>
        <button data-tab='bloc' class='active'>üõ†Ô∏è Bloc</button>
        <button data-tab='postop'>üíä Post-op</button>
      </div>
      <div id='tabContent' class='mt-3'></div>
    `;

    // Procedures UI
    if(item.procedures && item.procedures.length){
      const box = card.querySelector('#procList');
      const current = state.selectedProc[item.id] || null;
      item.procedures.forEach(p=>{
        const id=`proc-${item.id}-${p.id}`;
        const row=document.createElement('label'); row.className='flex items-center gap-2 p-2 rounded border'; row.style.borderColor='var(--border)';
        row.innerHTML=`<input type='radio' name='proc-${item.id}' id='${id}' ${current===p.id? 'checked':''}/> <span class='text-sm'>${p.label}</span>`;
        row.querySelector('input').addEventListener('change',()=>{ state.selectedProc[item.id]=p.id; renderTab(currentTab()); });
        box.appendChild(row);
      });
      card.querySelector('#btnClearProc').onclick=()=>{ delete state.selectedProc[item.id]; renderTab(currentTab()); box.querySelectorAll('input').forEach(i=>i.checked=false); };
    }

    card.querySelector('#btnCompose2').onclick=()=>composeReport(item);

    const tabs=card.querySelectorAll('[data-tab]');
    tabs.forEach(btn=>btn.onclick=()=>{ tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderTab(btn.dataset.tab); });
    function currentTab(){ const a=[...tabs].find(b=>b.classList.contains('active')); return a?a.dataset.tab:'bloc'; }
    function bullets(arr){ return `<ul class='list-dash space-y-1 text-sm'>${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`; }
    function renderTab(name){
      const c=card.querySelector('#tabContent');
      const procId=state.selectedProc[item.id];
      const proc=(item.procedures||[]).find(p=>p.id===procId);
      const bloc = proc? proc.bloc : item.bloc;
      const postop = proc? proc.postop : item.postop;
      c.innerHTML = name==='bloc' ? bullets(bloc) : bullets(postop);
    }
    renderTab('bloc');
    wrap.appendChild(card);
    window.scrollTo({ top: card.offsetTop - 80, behavior: 'smooth' });
  }

  function composeReport(item){
    const text = makeReport(item, state.selectedProc[item.id]);
    document.getElementById('report').value = text;
    localStorage.setItem('gta_rp_chir_report', text);
  }

  // Events
  document.getElementById('q').oninput = e=>{ state.q=e.target.value; renderResults(); };
  document.getElementById('btnReset').onclick = ()=>{ document.getElementById('q').value=''; state.q=''; renderResults(); };
  document.getElementById('btnCopy').onclick = ()=> navigator.clipboard.writeText(document.getElementById('report').value||'');
  document.getElementById('btnDownload').onclick = ()=> blobDownload('rapport_chirurgie_RP.txt', document.getElementById('report').value||'');

  // Init
  renderResults();
  const cached=localStorage.getItem('gta_rp_chir_report'); if(cached) document.getElementById('report').value=cached;
  </script>
</body>
</html>
