<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RP ‚Äî Guide Op√©ratoire Chirurgie</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e2e8f0; --muted:#94a3b8;
      --accent:#6366f1; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#1f2937; --chip:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;
      background:radial-gradient(1200px 600px at 20% -10%,#1e293b 0,#0b1020 60%,#060913 100%);color:var(--text)}
    .container{max-width:1000px;margin:40px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#8b5cf6);box-shadow:0 10px 25px rgba(99,102,241,.35)}
    h1{font-size:clamp(22px,3vw,28px);margin:0;letter-spacing:.2px}
    .pill{font-size:12px;padding:6px 10px;border:1px solid #334155;border-radius:999px;color:#a5b4fc;background:rgba(99,102,241,.08)}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:600;letter-spacing:.2px}
    .btn.secondary{background:transparent;border:1px solid #334155;color:var(--text)}
    .btn.ghost{background:transparent;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    select,textarea,input[type="text"]{width:100%;background:#0a0f1b;color:var(--text);border:1px solid #192133;padding:10px 12px;border-radius:12px;outline:none}
    select:focus,textarea:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.25)}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;background:var(--chip);border:1px solid #1f2937;font-size:14px}
    .section-title{font-size:18px;font-weight:700;margin:6px 0 10px}
    .titlebar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
    .results{display:grid;gap:12px}
    .block{border:1px solid #1f2937;border-left:4px solid var(--accent);padding:12px;border-radius:12px;background:#0a0f1b}
    .block.success{border-left-color:var(--accent2)}
    .block.warn{border-left-color:var(--warn)}
    .block.danger{border-left-color:var(--danger)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
    .muted{color:var(--muted)}
    .sub{font-weight:700;margin-bottom:6px}
    footer{margin-top:16px;color:#94a3b8;font-size:12px}
    .two{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:720px){.two{grid-template-columns:1fr 1fr}}
    .thinline{height:1px;background:#1f2937;margin:10px 0}
    .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Guide Op√©ratoire ‚Äî Chirurgie (RP)</h1>
          <div class="pill" aria-live="polite">Orientation sur sc√®ne & bloc ¬∑ RP uniquement</div>
        </div>
      </div>
      <div class="right">
        <button class="btn ghost" id="btn-start" title="M√©moriser l'heure de d√©but">üïí D√©but intervention</button>
        <span class="pill" id="start-pill">D√©but: ‚Äî</span>
        <button class="btn ghost" id="btn-export">Exporter</button>
        <button class="btn ghost" id="btn-print">Imprimer</button>
      </div>
    </header>

    <div class="grid">
      <!-- FORM -->
      <section class="card" aria-labelledby="form-title">
        <div class="titlebar">
          <div class="section-title" id="form-title">Cas & choix op√©ratoires</div>
          <div class="muted">Remplissez puis cliquez <span class="kbd">G√©n√©rer</span></div>
        </div>

        <div class="row" style="gap:16px">
          <div style="flex:1 1 280px;min-width:260px">
            <label for="specialty">Sp√©cialit√©</label>
            <select id="specialty">
              <option value="ortho">Orthop√©die ‚Äî R√©paration osseuse</option>
              <option value="neuro_crane">Neuro ‚Äî Chirurgie cr√¢nienne</option>
              <option value="spine">Rachis ‚Äî Colonne vert√©brale</option>
              <option value="thorax">Thorax ‚Äî Chirurgie thoracique</option>
              <option value="cardio">Cardiaque ‚Äî Chirurgie cardiaque</option>
              <option value="viscerale">Visc√©rale ‚Äî Digestif</option>
              <option value="burns">Br√ªl√©s ‚Äî Grands br√ªl√©s</option>
              <option value="neuro_trauma">Neuro ‚Äî Traumatologie</option>
            </select>
          </div>

          <div style="flex:1 1 320px;min-width:280px">
            <label for="procedure">Proc√©dure</label>
            <select id="procedure"></select>
          </div>

          <div style="flex:1 1 100%">
            <label for="context">Contexte / m√©canisme (RP)</label>
            <textarea id="context" rows="2" placeholder="Ex. chute haute √©nergie / GSW thorax G / polytraumatis√©..."></textarea>
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:8px">
          <span class="chip"><input type="checkbox" id="flag-gsw"/> Blessure par balle</span>
          <span class="chip"><input type="checkbox" id="flag-unstable"/> Patient instable (choc suspect)</span>
          <span class="chip"><input type="checkbox" id="flag-airway"/> Atteinte voie a√©rienne</span>
        </div>

        <div class="row" style="gap:10px;margin-top:14px">
          <button class="btn" id="btn-generate">G√©n√©rer</button>
          <button class="btn secondary" id="btn-reset">R√©initialiser</button>
        </div>
      </section>

      <!-- OUTPUT -->
      <section class="card" aria-labelledby="out-title">
        <div class="titlebar">
          <div class="section-title" id="out-title">Plan & Rapport</div>
          <div class="right">
            <button class="btn" id="btn-copy">üìã Copier le rapport</button>
          </div>
        </div>

        <div id="out-empty" class="block warn" style="display:none">
          Renseignez le cas et cliquez <span class="kbd">G√©n√©rer</span>.
        </div>

        <div class="results" id="results" style="display:none">
          <div class="two">
            <div class="block">
              <div class="sub">Sur sc√®ne ‚Äî Priorit√©s</div>
              <ul id="list-scene"></ul>
            </div>
            <div class="block">
              <div class="sub">Examens √† pr√©voir</div>
              <ul id="list-exams"></ul>
            </div>
          </div>

          <div class="thinline"></div>

          <div class="block">
            <div class="sub">√âtapes op√©ratoires (RP)</div>
            <ul id="list-steps"></ul>
          </div>

          <div class="two">
            <div class="block success">
              <div class="sub">Post-op / Surveillance</div>
              <ul id="list-postop"></ul>
            </div>
            <div class="block">
              <div class="sub">Complications / Points de vigilance</div>
              <ul id="list-comp"></ul>
            </div>
          </div>

          <div class="block">
            <div class="sub">Rapport (pr√©-rempli)</div>
            <textarea id="report" rows="8"></textarea>
          </div>
        </div>
      </section>
    </div>

    <footer>¬© <span id="year"></span> ‚Äî RP Guide Op√©ratoire. Heuristiques RP, ne remplace pas un avis r√©el.</footer>
  </div>

  <script>
    // ====== Donn√©es: synth√®se depuis ton contenu (r√©sum√© RP) ======
    const DB = {
      ortho: {
        label: "Orthop√©die ‚Äî R√©paration osseuse",
        procedures: {
          broches: {
            label: "R√©paration avec broches/clous",
            scene: [
              "Immobilisation segmentaire, contr√¥le h√©morragie",
              "Antalgie, √©valuer vasculo-nerveux distal (pouls, sensibilit√©, motricit√©)",
            ],
            exams: ["RX segment en 2 incidences", "¬± TDM si fracture complexe", "Bilan pr√©-op standard"],
            steps: [
              "Incision cibl√©e, r√©duction ferm√©e/ouverte",
              "Insertion clou intram√©dullaire / broches transfixiantes",
              "Contr√¥le radioscopique des axes et de la longueur",
              "Fixations distales/proximales si besoin, fermeture",
            ],
            postop: ["Contention/attelle", "Antalgie, glace, sur√©l√©vation", "Surveillance NV distale"],
            comp: ["Mal-alignement / retard de consolidation", "Infection, saignement", "L√©sion vasculo-nerveuse"],
          },
          vis: {
            label: "Ost√©osynth√®se par vis",
            scene: ["Immobilisation stricte", "Antalgie, protection plaies"],
            exams: ["RX ¬± TDM", "Bilan pr√©-op"],
            steps: [
              "R√©duction, forage, taraudage si n√©cessaire",
              "Mise en place de vis (compression perpendiculaire √† la fracture)",
              "Contr√¥le radioscopique et fermeture",
            ],
            postop: ["Repos, immobilisation adapt√©e", "Contr√¥le douleur & NV", "RX de contr√¥le"],
            comp: ["D√©placement secondaire", "Mat√©riel saillant / irritation", "Infection"],
          },
          plaques: {
            label: "Plaques + vis",
            scene: ["Immobilisation, √©valuer peau/tissus mous"],
            exams: ["RX 2 incidences", "TDM si intra-articulaire", "Bilan pr√©-op"],
            steps: [
              "Voie d‚Äôabord, r√©duction anatomique",
              "Adaptation plaque, vissage s√©quentiel",
              "Contr√¥le stabilit√© & mobilit√© articulaire",
            ],
            postop: ["Contention, glace, √©l√©vation", "Antibioprophylaxie RP selon contexte", "R√©√©ducation selon site"],
            comp: ["Risque infectieux", "Cal vicieux", "Intol√©rance mat√©riel"],
          },
          pate: {
            label: "P√¢te / substituts osseux (comblement)",
            scene: ["Immobilisation, h√©mostase"],
            exams: ["RX/TDM pour d√©fect osseux", "Bilan pr√©-op"],
            steps: [
              "Pr√©paration site, d√©bridement",
              "Mise en place substitut (autologue/synth√©tique)",
              "Association ost√©osynth√®se si n√©cessaire",
            ],
            postop: ["Repos, √©viter appui", "Surveillance douleur/≈ìd√®me", "Contr√¥le imagerie √† distance"],
            comp: ["R√©sorption insuffisante", "Infection", "Non-int√©gration"],
          },
        }
      },

      neuro_crane: {
        label: "Neuro ‚Äî Chirurgie cr√¢nienne",
        procedures: {
          craniotomie: {
            label: "Craniotomie",
            scene: ["ABCDE, GCS, pr√©vention HTIC", "Si h√©matome suspect: √©vacuation rapide vers bloc (RP)"],
            exams: ["CT c√©r√©brale ¬± angio", "Bilan pr√©-op"],
            steps: [
              "Incision et volet osseux",
              "Traitement l√©sionnel (drainage h√©matome / ex√©r√®se l√©sion)",
              "Remise en place du volet (plaques/vis titane)",
            ],
            postop: ["Surveillance neuro (GCS, pupilles)", "CT de contr√¥le", "Pr√©vention crises / ATB selon geste"],
            comp: ["H√©morragie, infection", "≈íd√®me/HTIC", "Crises convulsives"],
          },
          cranioplastie: {
            label: "Cr√¢nioplastie",
            scene: ["Protection zone d√©fect, casque si besoin"],
            exams: ["CT 3D pour implant", "Bilan infectieux"],
            steps: [
              "Pr√©paration site, adaptation implant (autogreffe/titane/PMMA)",
              "Fixation plaques/vis",
            ],
            postop: ["ATB prophylaxie RP", "Surveillance plaie et neuro"],
            comp: ["Infection implant", "D√©collement, h√©matome sous-galeal"],
          },
          plaques_vis: {
            label: "Plaques/vis cr√¢niennes",
            scene: ["Protection, contr√¥le saignement", "GCS r√©gulier"],
            exams: ["CT osseux", "Bilan"],
            steps: ["R√©duction fragments", "Fixation mini-plaques/vis"],
            postop: ["Surveillance neuro/plaie", "Analgesie"],
            comp: ["Infection, d√©placement mat√©riel"],
          },
          ciment: {
            label: "Ciment (PMMA / Hydroxyapatite)",
            scene: ["Protection d√©faut osseux"],
            exams: ["CT 3D", "Bilan"],
            steps: ["Moulage et comblement", "Stabilisation"],
            postop: ["Surveillance locale", "ATB si indiqu√©"],
            comp: ["Rejet/inf", "Irr√©gularit√©s"],
          },
        }
      },

      spine: {
        label: "Rachis ‚Äî Colonne",
        procedures: {
          discectomie: {
            label: "Discectomie",
            scene: ["Immobilisation rachidienne si trauma", "Antalgie, d√©ficit neuro?"],
            exams: ["IRM/CT selon niveau", "RX dynamique si d√©g√©n√©ratif"],
            steps: [
              "Voie d‚Äôabord (post/ant selon niveau)",
              "Ablation fragment discal compressif",
              "¬± dispositif intersomatique",
            ],
            postop: ["Ceinture/colier selon niveau", "R√©√©ducation", "Antalgie"],
            comp: ["R√©cidive hernie", "D√©ficit neuro", "Infection"],
          },
          laminectomie: {
            label: "Laminectomie (d√©compression)",
            scene: ["Pr√©cautions rachis", "Eval neuro"],
            exams: ["IRM/CT", "Bilan"],
            steps: ["Ablation lames vert√©brales", "D√©compression canal/foramens"],
            postop: ["Surveillance motrice/sensitive", "Antalgie"],
            comp: ["Instabilit√© secondaire", "Infection"],
          },
          fusion: {
            label: "Fusion vert√©brale",
            scene: ["Immobilisation rigoureuse", "Antalgie"],
            exams: ["IRM/CT", "Planification vis/ponts"],
            steps: ["Pr√©paration plateau", "Greffon (auto/allo/substitut)", "Vis p√©diculaires + tiges ¬± cage"],
            postop: ["Corset/colier", "R√©√©ducation", "RX/CT contr√¥le"],
            comp: ["Pseudarthrose", "Malposition vis", "Infection"],
          },
          foraminotomie: {
            label: "Foraminotomie",
            scene: ["R/O d√©ficit aigu", "Antalgie"],
            exams: ["IRM", "Bilan"],
            steps: ["Agrandissement foramen", "Lib√©ration racine"],
            postop: ["Mobilisation prudente", "Antalgie"],
            comp: ["Dure-m√®re, h√©morragie", "D√©ficit persistant"],
          },
          scoliose: {
            label: "Chirurgie scoliose",
            scene: ["Bilan respi, neuro", "Planif niveau fusion"],
            exams: ["RX corps entier EOS", "CT planif vis"],
            steps: ["Vis p√©diculaires longues", "Tiges, correction progressive", "Fusion multi-√©tage"],
            postop: ["Surveillance respi", "R√©√©ducation progressive"],
            comp: ["Pseudarthrose", "Infection", "D√©ficit iatrog√®ne"],
          },
          prothese: {
            label: "Proth√®se discale",
            scene: ["Indication d√©g√©n√©rative sans instabilit√©"],
            exams: ["IRM/CT mesure discale"],
            steps: ["Abord ant√©rieur", "Ablation disque", "Implant proth√®se mobile"],
            postop: ["Kin√©sith√©rapie", "Contr√¥le radio"],
            comp: ["Mauvais positionnement", "Usure implant"],
          },
          vertebro: {
            label: "Vert√©bro/Cyphoplastie",
            scene: ["Fracture compression? douleur aigu√´"],
            exams: ["RX/CT ¬± IRM ≈ìd√®me", "Bilan coag"],
            steps: ["(Cypho) ballon ‚Üí restauration hauteur", "Injection ciment (PMMA)"],
            postop: ["Surveillance fuite ciment", "Antalgie"],
            comp: ["Fuite ciment", "√âchec douleur"],
          },
        }
      },

      thorax: {
        label: "Thorax ‚Äî Chirurgie thoracique",
        procedures: {
          lobectomie:{label:"Lobectomie",scene:["ABC, O‚ÇÇ, douleur","GSW thorax: pansement occlusif 3 c√¥t√©s (RP)"],
            exams:["TDM thoracique ¬± PET","EFR si possible"],steps:["Abord VATS/thoracotomie","Section p√©dicules (bronche/vx)","R√©section lobe, contr√¥le √©tanch√©it√©"],
            postop:["Drain thoracique","KT douleur, kin√© respi"],comp:["Fuite a√©rienne prolong√©e","Infection, at√©lectasie"]},
          pneumonectomie:{label:"Pneumonectomie",scene:["Stabiliser respiration, h√©modynamique"],exams:["TDM, √©cho cardiaque"],steps:["Clampage vx/bronche","R√©section poumon entier","Drainage adapt√©"],
            postop:["USI, surveillance respi/h√©modyn"],comp:["≈íd√®me post-pneumonectomie","Insuffisance respi"]},
          mediastino:{label:"M√©diastinoscopie/m√©diastinotomie",scene:["Airway check"],exams:["TDM/IRM m√©diastin"],steps:["Biopsies/abord tumoral"],postop:["Surveillance saignement"],comp:["L√©sion vasculaire/nerveuse"]},
          oesophage:{label:"≈ísophagectomie",scene:["Voies a√©riennes, nutrition anticip√©e"],exams:["TDM, endoscopie"],steps:["R√©section, ascension gastrique","Anastomose"],postop:["Sonde nutrition","Contr√¥le fistule"],comp:["Fuite anastomotique","Pneumonie"]},
          decortication:{label:"D√©cortication pleurale",scene:["Analgesie, O‚ÇÇ"],exams:["TDM pleural"],steps:["Ablation coque fibreuse","Lib√©ration pulmonaire"],postop:["Drain, kin√© respi"],comp:["H√©morragie","Infection"]},
          tracheo:{label:"Trach√©otomie",scene:["Airway prioritaire"],exams:["‚Äî"],steps:["Ouverture trach√©e","Mise en place canule"],postop:["Soins canule, aspiration"],comp:["H√©morragie","Infection","St√©nose"]},
          trauma:{label:"Trauma thoracique",scene:["Occlusif 3 c√¥t√©s, drain selon RP","Stabiliser c√¥tes"],exams:["TDM trauma","RX lit"],steps:["Drain pleural","Fixation c√¥tes si volet s√©v√®re"],postop:["Surveillance respi, douleur"],comp:["H√©mothorax r√©siduel","Empy√®me"]},
        }
      },

      cardio: {
        label: "Cardiaque ‚Äî Chirurgie",
        procedures: {
          cabg:{label:"Pontage coronarien",scene:["O‚ÇÇ, anti-isch√©mique RP si besoin"],exams:["Coronarographie","Echo"],steps:["Sternotomie","Pr√©l√®vement greffons","Pontages distaux"],postop:["USI, inotrope si besoin"],comp:["Saignement","FA post-op"]},
          valve:{label:"R√©paration/Remplacement valvulaire",scene:["Pr√©parer anticoag/antibioprophylaxie RP"],exams:["Echo TTE/TEE"],steps:["Abord cardiaque","R√©paration anneau/feuillets ou proth√®se"],postop:["Anticoag selon proth√®se","Echo de contr√¥le"],comp:["Dysfonction proth√®se","Endocardite"]},
          maze:{label:"FA ‚Äî Maze/Ablation",scene:["Risque thrombo"],exams:["Echo, anticoag"],steps:["L√©sions de conduction (cryo/RF)"],postop:["Rythme, anticoag"],comp:["R√©cidive FA"]},
          transplant:{label:"Transplantation cardiaque",scene:["USI, support"],exams:["Bilan complet compatibilit√©"],steps:["Explant donneur, implant receveur"],postop:["Immunosuppresseurs"],comp:["Rejet, infection"]},
          vad:{label:"Assistance ventriculaire (VAD)",scene:["Choc cardiog√©nique"],exams:["Echo, cath√©"],steps:["Implant VAD (VG¬±VD)"],postop:["R√©glages device, anticoag"],comp:["Thrombose","Infection device"]},
        }
      },

      viscerale: {
        label: "Visc√©rale ‚Äî Digestif",
        procedures: {
          appendice:{label:"Appendicectomie",scene:["Antalgie, ATB si sepsis"],exams:["Echo/CT"],steps:["Voie ouverte/laparo","Section et fermeture moignon"],postop:["R√©gime, ATB si compliqu√©e"],comp:["Abc√®s","Fistule rare"]},
          chole:{label:"Chol√©cystectomie",scene:["Douleur, je√ªne"],exams:["Echo biliaire ¬± bilan h√©patique"],steps:["Laparoscopie 4 trocarts","Clip cystique/ART","Ex√©r√®se"],postop:["Surveillance douleur, alimentation progressive"],comp:["L√©sion voie biliaire","H√©morragie"]},
          hernie:{label:"Herniorraphie/Hernioplastie",scene:["R√©duction douce si possible"],exams:["‚Äî (clinique) ¬± echo"],steps:["R√©duction sac","Suture paroi ou filet"],postop:["Ceinture, repos"],comp:["R√©cidive","S√©rome"]},
          resection:{label:"R√©section intestinale",scene:["Fluides, ATB"],exams:["CT abdo"],steps:["R√©section segment","Anastomose ¬± stomie"],postop:["Transit, ATB selon"],comp:["Fuite anastomotique","Il√©us"]},
          gastrectomie:{label:"Gastrectomie (partielle/totale)",scene:["Pr√©parer nutrition"],exams:["Endoscopie, CT"],steps:["R√©section","Reconstruction (Billroth/Roux-en-Y)"],postop:["SNG, r√©alimentation"],comp:["Fuite, carences"]},
          bariatrique:{label:"Bariatrique (Sleeve/Bypass)",scene:["Bilan nutritif"],exams:["Endoscopie"],steps:["Sleeve ou Bypass"],postop:["Suppl√©mentation"],comp:["Fuites, carences"]},
          hepatectomie:{label:"H√©patectomie",scene:["Bilan coag"],exams:["IRM/CT h√©patique"],steps:["R√©section segmentaire"],postop:["Surv. h√©morragie, bilans"],comp:["Bile leak","Insuffisance h√©patique"]},
          pancreatectomie:{label:"Pancr√©atectomie",scene:["Douleur, enzymes"],exams:["CT/IRM"],steps:["Whipple / distale"],postop:["Surv. fistule, glyc√©mie"],comp:["Fistule pancr√©atique"]},
          tumeurs:{label:"R√©section tumeurs abdominales",scene:["‚Äî"],exams:["CT/IRM","Marqueurs"],steps:["Ex√©r√®se ¬± curage"],postop:["Surv. saignement"],comp:["Fuite, h√©morragie"]},
          splenectomie:{label:"Spl√©nectomie",scene:["Vaccins (RP) si possible"],exams:["Echo/CT"],steps:["Abord ouvert/laparo","Ligatures p√©dicule"],postop:["Vaccins si non faits","Risque infectieux"],comp:["Sepsis fulminans"]},
        }
      },

      burns: {
        label:"Br√ªl√©s ‚Äî Grands br√ªl√©s",
        procedures: {
          grands_brules: {
            label:"Prise en charge grands br√ªl√©s",
            scene:[
              "Stopper l‚Äôagent causal, refroidir 10‚Äì20 min (eau temp√©r√©e)",
              "ABCDE, assurer voie a√©rienne (inhalation?)",
              "R√©animation liquidienne (formule de Parkland RP)",
              "Analgesie, couverture thermique"
            ],
            exams:["√âvaluer %SCB (r√®gle des 9)","Photos/tra√ßage","Bilan biologique"],
            steps:[
              "Toilette/d√©bridement",
              "Pansements antimicrobiens",
              "Greffes cutan√©es (auto/allo) si profondes ou √©tendues"
            ],
            postop:["Antalgie soutenue","Kin√©/orth√®ses antid√©formations","Suivi nutritionnel/psychologique"],
            comp:["Infections","Cicatrices hypertrophiques/contractures","Troubles hydro-√©lectrolytiques"]
          }
        }
      },

      neuro_trauma: {
        label:"Neuro ‚Äî Traumatologie",
        procedures:{
          tcc:{
            label:"Traumatisme cr√¢nien (TCC)",
            scene:["GCS, immobilisation cou","Airway/O‚ÇÇ, pr√©vention HTIC","ATCD anticoagulants ?"],
            exams:["CT c√©r√©brale ¬± contr√¥le","Bilan coag"],
            steps:["Craniotomie d√©compressive si HTIC/h√©matome","Surveillance rapproch√©e"],
            postop:["Sevrage progressif", "Pr√©vention crises", "R√©√©ducation"],
            comp:["≈íd√®me/HTIC","Hydroc√©phalie","Troubles cognitifs"]
          },
          moelle:{
            label:"L√©sion m√©dullaire",
            scene:["Immobilisation rachis stricte","Airway/respiration","Choc neurog√©nique ?"],
            exams:["IRM rachidienne","CT osseuse"],
            steps:["D√©compression/fixation","Soins de nursing sp√©cialis√©s"],
            postop:["R√©√©ducation longue","Pr√©vention escarres","Gestion sphinct√©riens"],
            comp:["Spasticit√©","Infections","Douleurs neuropathiques"]
          },
          nerfs:{
            label:"L√©sions nerfs p√©riph√©riques",
            scene:["Protection plaie, √©valuer d√©ficit sensitivo-moteur"],
            exams:["EMG √† distance (RP)","Echo nerveuse ¬± IRM"],
            steps:["Suture/greffe nerveuse selon d√©lai","Neurolyse si compression"],
            postop:["R√©√©ducation fine","Orth√®ses fonctionnelles"],
            comp:["Douleurs neuro", "D√©ficit persistant"]
          }
        }
      }
    };

    // ====== √âl√©ments ======
    const els = {
      specialty: document.getElementById('specialty'),
      procedure: document.getElementById('procedure'),
      context: document.getElementById('context'),
      flagGSW: document.getElementById('flag-gsw'),
      flagUnstable: document.getElementById('flag-unstable'),
      flagAirway: document.getElementById('flag-airway'),
      btnGen: document.getElementById('btn-generate'),
      btnReset: document.getElementById('btn-reset'),
      btnCopy: document.getElementById('btn-copy'),
      btnExport: document.getElementById('btn-export'),
      btnPrint: document.getElementById('btn-print'),
      btnStart: document.getElementById('btn-start'),
      startPill: document.getElementById('start-pill'),
      outEmpty: document.getElementById('out-empty'),
      results: document.getElementById('results'),
      listScene: document.getElementById('list-scene'),
      listExams: document.getElementById('list-exams'),
      listSteps: document.getElementById('list-steps'),
      listPost: document.getElementById('list-postop'),
      listComp: document.getElementById('list-comp'),
      report: document.getElementById('report')
    };

    // ====== Heure de d√©but ======
    let startAt = null;
    function fmt(dt){
      return dt.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    els.btnStart.addEventListener('click', ()=>{
      startAt = new Date();
      els.startPill.textContent = 'D√©but: ' + fmt(startAt);
      const old = els.btnStart.textContent; els.btnStart.textContent='‚úÖ Heure enregistr√©e';
      setTimeout(()=> els.btnStart.textContent = old, 1200);
    });

    // ====== Init proc√©dures selon sp√©cialit√© ======
    function populateProcedures(){
      const spec = els.specialty.value;
      const data = DB[spec].procedures;
      els.procedure.innerHTML = '';
      Object.keys(data).forEach(key=>{
        const opt = document.createElement('option');
        opt.value = key; opt.textContent = data[key].label;
        els.procedure.appendChild(opt);
      });
    }
    els.specialty.addEventListener('change', populateProcedures);
    populateProcedures();

    // ====== Helpers render ======
    function ulFill(ul, items){ ul.innerHTML = (items||[]).map(x=>`<li>${x}</li>`).join(''); }

    function applyModifiers(scene, exams, steps){
      // Modifs RP selon flags
      if (els.flagGSW.checked){
        scene.unshift("GSW: contr√¥le h√©morragie, pansement occlusif si thorax, √©vacuation rapide RP");
        exams.unshift("TDM zone d'impact ¬± body-scan trauma");
        steps.unshift("D√©bridement/exploration trajectoire (RP), h√©mostase, pr√©paration pour chirurgie d√©finitive");
      }
      if (els.flagUnstable.checked){
        scene.unshift("Instabilit√©: prioriser MARCH/ABCDE, voies veineuses, remplissage prudent, r√©chauffement");
        exams.unshift("Bilans urgents (GDS, Hb, lactates), √©cho FAST");
      }
      if (els.flagAirway.checked){
        scene.unshift("Airway critique: s√©curiser (intubation/trach√©otomie selon), O‚ÇÇ haut d√©bit");
        steps.unshift("Contr√¥le voie a√©rienne au bloc avant tout geste");
      }
    }

    // ====== G√©n√©ration plan/report ======
    function generate(){
      const spec = els.specialty.value;
      const proc = els.procedure.value;
      const obj = DB[spec].procedures[proc];

      // Clone arrays to avoid mutating DB
      const scene = [...(obj.scene||[])];
      const exams = [...(obj.exams||[])];
      const steps = [...(obj.steps||[])];
      const postop = [...(obj.postop||[])];
      const comp = [...(obj.comp||[])];

      applyModifiers(scene, exams, steps);

      ulFill(els.listScene, scene);
      ulFill(els.listExams, exams);
      ulFill(els.listSteps, steps);
      ulFill(els.listPost, postop);
      ulFill(els.listComp, comp);

      // Rapport
      const startLine = startAt ? `D√©but intervention: ${fmt(startAt)}\n` : '';
      const flags = [
        els.flagGSW.checked ? "GSW" : null,
        els.flagUnstable.checked ? "instable" : null,
        els.flagAirway.checked ? "atteinte voie a√©rienne" : null
      ].filter(Boolean).join(", ");

      const report =
`${startLine}Sp√©cialit√©: ${DB[spec].label}
Proc√©dure: ${obj.label}
Contexte: ${els.context.value || '‚Äî'}
Drapeaux: ${flags || '‚Äî'}

Sur sc√®ne:
 - ${scene.join('\n - ')}

Examens:
 - ${exams.join('\n - ')}

Geste op√©ratoire:
 - ${steps.join('\n - ')}

Post-op:
 - ${postop.join('\n - ')}

Complications surveill√©es:
 - ${comp.join('\n - ')}

Compte-rendu synth√®se:
Patient pris en charge pour ${obj.label.toLowerCase()}. Gestes r√©alis√©s selon protocole RP, surveillance post-op assur√©e.`;

      els.report.value = report;

      els.outEmpty.style.display = 'none';
      els.results.style.display = 'grid';
    }

    // ====== Actions ======
    els.btnGen.addEventListener('click', generate);
    els.btnReset.addEventListener('click', ()=>{
      els.context.value = '';
      els.flagGSW.checked = false;
      els.flagUnstable.checked = false;
      els.flagAirway.checked = false;
      els.results.style.display='none';
      els.outEmpty.style.display='block';
      startAt=null; els.startPill.textContent='D√©but: ‚Äî';
    });

    els.btnCopy.addEventListener('click', ()=>{
      const txt = els.report.value || '';
      navigator.clipboard.writeText(txt).then(()=>{
        const old = els.btnCopy.textContent; els.btnCopy.textContent = '‚úî Rapport copi√©';
        setTimeout(()=> els.btnCopy.textContent = old, 1200);
      });
    });

    els.btnExport.addEventListener('click', ()=>{
      const payload = {
        startAt: startAt ? startAt.toISOString() : null,
        specialty: els.specialty.value,
        procedure: els.procedure.value,
        context: els.context.value,
        flags: { gsw: els.flagGSW.checked, unstable: els.flagUnstable.checked, airway: els.flagAirway.checked },
        report: els.report.value
      };
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`rp_chirurgie_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    els.btnPrint.addEventListener('click', ()=> window.print());

    // ====== Init ======
    document.getElementById('year').textContent = new Date().getFullYear();
    // Affiche un bloc d'aide tant que rien n‚Äôest g√©n√©r√©
    els.outEmpty.style.display='block';
  </script>
</body>
</html>
